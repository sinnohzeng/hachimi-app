# è®¿å®¢æ¨¡å¼ + è¡Œä¸ºå°è´¦ + æœ¬åœ°ä¼˜å…ˆæ¶æ„

## Context

å½“å‰ Hachimi å­˜åœ¨ä¸‰ä¸ªæ ¸å¿ƒæ¶æ„é—®é¢˜ï¼š

1. **ç™»å½•å¢™**ï¼šOnboarding åå¿…é¡» Google/Email ç™»å½•æ‰èƒ½ä½¿ç”¨ï¼Œæ–°ç”¨æˆ·æµå¤±ä¸¥é‡
2. **ç½‘ç»œä¾èµ–**ï¼šç­¾åˆ°/é…é¥°æ“ä½œä½¿ç”¨ Firestore `runTransaction` â†’ ç¦»çº¿ç›´æ¥å¤±è´¥ï¼›StreamProvider åˆå§‹åŒ–æ—¶æ˜¾ç¤º spinner
3. **æ— å®¡è®¡è½¨è¿¹**ï¼šé‡‘å¸å¢å‡ã€ç­¾åˆ°è®°å½•æ•£è½åœ¨ Firestore å„å¤„ï¼Œå‡ºç°æ•°æ®ä¸ä¸€è‡´æ—¶æ— æ³•æº¯æº
4. **æˆå°±ç³»ç»Ÿè„†å¼±**ï¼šæˆå°±è¯„ä¼°ä¾èµ–å±å¹•æ‰‹åŠ¨è°ƒç”¨ `triggerAchievementEvaluation`ï¼Œå®¹æ˜“é—æ¼è§¦å‘ç‚¹ï¼›æˆå°±å­˜å‚¨åœ¨ Firestore â†’ ç¦»çº¿å¤±è´¥

**ç›®æ ‡**ï¼š
- ç”¨æˆ· Onboarding åç«‹å³ä»¥"è®¿å®¢"è¿›å…¥åº”ç”¨ï¼ˆAI åŠŸèƒ½é™¤å¤–ï¼‰
- æ‰€æœ‰æ“ä½œä¼˜å…ˆæœ¬åœ°æ‰§è¡Œï¼ŒFirebase é€€å±…"äº‘åŒæ­¥"è§’è‰²ï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
- å¼•å…¥ **è¡Œä¸ºå°è´¦**ï¼ˆAction Ledgerï¼‰ä½œä¸ºæœ¬åœ° SSOT â€” æ¯ä¸ªç”¨æˆ·è¡Œä¸ºç”Ÿæˆå”¯ä¸€ UUIDï¼Œè®°å½•å®Œæ•´çš„æ—¶é—´çº¿ã€è¾“å…¥å’Œäº§å‡º
- æˆå°±ç³»ç»Ÿ**äº‹ä»¶é©±åŠ¨åŒ–** â€” å°è´¦å†™å…¥è‡ªåŠ¨è§¦å‘æˆå°±è¯„ä¼°ï¼Œå½¢æˆé—­ç¯

**é‡è¦çº¦æŸ**ï¼š
- **åŒæ­¥å¯¹ç”¨æˆ·å®Œå…¨é€æ˜** â€” ä¸»ç•Œé¢ä¸å±•ç¤ºä»»ä½•åŒæ­¥çŠ¶æ€/è¿›åº¦ï¼ŒSyncEngine é™é»˜è¿è¡Œï¼›ä»…åœ¨è®¾ç½®é¡µåº•éƒ¨ä½è°ƒæ˜¾ç¤º"æœ€ååŒæ­¥æ—¶é—´"
- **æ— å†å²æ•°æ®å…¼å®¹** â€” é¡¹ç›®å°šæœªæ­£å¼å‘å¸ƒï¼Œä¸éœ€è¿ç§»æ—§æ•°æ®

---

## æ¶æ„å†³ç­–ï¼šä¸ºä»€ä¹ˆç”¨è¡Œä¸ºå°è´¦æ›¿ä»£ SharedPreferences ç¼“å­˜

### åŸæ–¹æ¡ˆçš„é—®é¢˜

åŸæ–¹æ¡ˆ Part 2 ä½¿ç”¨ SharedPreferencesï¼ˆSPï¼‰åˆ†æ•£ç¼“å­˜é‡‘å¸ã€ç­¾åˆ°ã€ä¹ æƒ¯ç­‰çŠ¶æ€ã€‚è¿™æœ‰ä¸‰ä¸ªè‡´å‘½ç¼ºé™·ï¼š

1. **SP ä¸é€‚åˆç»“æ„åŒ–æ•°æ®** â€” JSON åºåˆ—åŒ– List/Map åˆ° SP æ˜¯åæ¨¡å¼ï¼Œä¸å¯æŸ¥è¯¢ã€ä¸æ”¯æŒåŸå­å¤šå­—æ®µæ›´æ–°
2. **å¤šå¥—å¹¶è¡Œç¼“å­˜** â€” é‡‘å¸ä¸€å¥— SPã€ç­¾åˆ°ä¸€å¥— SPã€ä¹ æƒ¯ç¼“å­˜ä¸€å¥— SPã€ç¦»çº¿é˜Ÿåˆ—åˆä¸€å¥— SP â†’ ç»´æŠ¤å™©æ¢¦
3. **æ— æ³•æº¯æº** â€” é‡‘å¸ä½™é¢ä¸å¯¹æ—¶ï¼Œæ— æ³•å›ç­”"æ˜¯å“ªç¬”æ“ä½œå¯¼è‡´çš„ï¼Ÿ"

### è¡Œä¸šæœ€ä½³å®è·µï¼šEvent Sourcing Lite

Todoistã€Linearã€Things 3ã€Day One ç­‰ç¦»çº¿ä¼˜å…ˆåº”ç”¨å‡é‡‡ç”¨ç±»ä¼¼æ¶æ„ï¼š

```
ç”¨æˆ·æ“ä½œ â†’ å†™å…¥æœ¬åœ°ä¸å¯å˜äº‹ä»¶æ—¥å¿— â†’ æ›´æ–°æœ¬åœ°ç‰©åŒ–çŠ¶æ€ â†’ åå°åŒæ­¥åˆ°äº‘ç«¯
```

æ ¸å¿ƒæ€æƒ³ï¼š**ä¸ç›´æ¥ä¿®æ”¹çŠ¶æ€ï¼Œè€Œæ˜¯è¿½åŠ äº‹ä»¶ã€‚å½“å‰çŠ¶æ€ = åˆå§‹çŠ¶æ€ + æ‰€æœ‰äº‹ä»¶çš„ç´¯ç§¯æ•ˆæœã€‚**

### æ–°æ–¹æ¡ˆ

ç”¨é¡¹ç›®å·²æœ‰çš„ **SQLite**ï¼ˆsqfliteï¼‰æ‰©å±•å¤šå¼ è¡¨ï¼Œæ›¿ä»£æ‰€æœ‰ SP ç¼“å­˜å’Œ OfflineWriteGuardã€‚

**æ¶æ„æ‹†åˆ†**ï¼ˆé¿å… God Classï¼‰ï¼š
- `LedgerService` â€” ä»…è´Ÿè´£ action_ledger è¡¨å†™å…¥ + materialized_state CRUD + å˜æ›´å¹¿æ’­
- `LocalHabitRepository` / `LocalCatRepository` / `LocalSessionRepository` â€” å„è‡ªè´Ÿè´£å¯¹åº”é¢†åŸŸè¡¨çš„ CRUD
- é¢†åŸŸ Repository å†…éƒ¨è°ƒç”¨ LedgerService å†™å°è´¦ï¼Œåœ¨åŒä¸€ä¸ª SQLite äº‹åŠ¡ä¸­å®Œæˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ“ä½œ     â”‚ â”€â”€â–º â”‚ action_ledger    â”‚ â”€â”€â–º â”‚ materialized  â”‚
â”‚ (ç­¾åˆ°/è®¡æ—¶ç­‰) â”‚     â”‚ (ä¸å¯å˜äº‹ä»¶æ—¥å¿—)  â”‚     â”‚ _state (ç‰©åŒ–) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ synced=0
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  åå°åŒæ­¥å¼•æ“     â”‚ â”€â”€â–º Firestore
                    â”‚  (connectivity)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 1ï¼šè®¿å®¢æ¨¡å¼ï¼ˆFirebase Anonymous Authï¼‰

> æ­¤éƒ¨åˆ†æ¶æ„è®¾è®¡ä¸åŸæ–¹æ¡ˆä¸€è‡´ï¼Œä»¥ä¸‹å¢è¡¥ M3 è®¾è®¡ç»†èŠ‚ã€‚

### 1.1 æ ¸å¿ƒæµç¨‹

```
Onboarding â†’ user==null â†’ signInAnonymously()ï¼ˆè‡ªåŠ¨ã€æ—  UIï¼‰â†’ HomeScreen
                                                  â†“
                          Profile â†’ "å…³è”è´¦å·" â†’ LoginScreen(linkMode) â†’ å‡çº§ä¸ºæ­£å¼ç”¨æˆ·
```

### 1.2 AuthService æ–°å¢

**æ–‡ä»¶**: [auth_service.dart](lib/services/auth_service.dart)

```dart
Future<UserCredential> signInAnonymously();
Future<UserCredential?> linkWithGoogle();   // user.linkWithCredential()
Future<UserCredential> linkWithEmail({required String email, required String password});
bool get isAnonymous;
```

- `linkWithCredential()` ä¿æŒåŒä¸€ UIDï¼Œæ‰€æœ‰ Firestore æ•°æ®è‡ªåŠ¨ä¿ç•™
- `credential-already-in-use` å¼‚å¸¸å¤„ç†ï¼š
  - "ç™»å½•å·²æœ‰è´¦å·"ï¼ˆæ”¾å¼ƒè®¿å®¢æ•°æ®ï¼Œåˆ‡æ¢åˆ°å·²ç»‘å®šçš„è´¦å·ï¼‰
  - "ä½¿ç”¨å…¶ä»–è´¦å·"ï¼ˆå°è¯•å…¶ä»– Google/Emailï¼‰
  - "å–æ¶ˆ"ï¼ˆä¿æŒè®¿å®¢çŠ¶æ€ï¼‰
- å…³è”æˆåŠŸåï¼šå¤ç”¨ `AchievementCelebrationLayer` æ’­æ”¾è½»é‡åº†ç¥åŠ¨ç”» + "AI åŠŸèƒ½å·²è§£é”"ï¼›å°è´¦è®°å½• `account_linked` äº‹ä»¶ï¼Œå¯è§¦å‘éšè—æˆå°±

### 1.3 AuthGate æ”¹é€ 

**æ–‡ä»¶**: [app.dart](lib/app.dart) L142-191

å½“ `user == null` æ—¶ï¼Œä¸å† `return LoginScreen()`ï¼Œæ”¹ä¸ºè‡ªåŠ¨åŒ¿åç™»å½•ï¼š

```dart
data: (user) {
  if (user == null) {
    _startAnonymousSignIn();  // å¸¦ _signingIn flag é˜²é‡å¤
    return _buildSplashScreen(); // M3 branded splashï¼Œä¸æ˜¯ spinner
  }
  // åç»­ä¸å˜ï¼šç¼“å­˜ UID â†’ _VersionGate
},
error: (e, _) => _buildRetryScreen(e), // ç¦»çº¿é¦–æ¬¡å¯åŠ¨
```

é¦–æ¬¡åŒ¿åç™»å½•æˆåŠŸå â†’ è°ƒç”¨ `createGuestProfile()` åœ¨ Firestore åˆ›å»ºç”¨æˆ·æ–‡æ¡£ + åœ¨ action_ledger è®°å½• `account_created` äº‹ä»¶ã€‚

**ç¦»çº¿é¦–æ¬¡å¯åŠ¨å›é€€**ï¼šFirebase Anonymous Auth éœ€è¦è”ç½‘ã€‚å½“å…¨æ–°å®‰è£… + æ— ç½‘ç»œæ—¶ï¼š
- ä½¿ç”¨ `uuid.v4()` ç”Ÿæˆä¸´æ—¶æœ¬åœ° UIDï¼ˆå‰ç¼€ `local_`ï¼‰ï¼Œå­˜å…¥ SharedPreferences
- æ‰€æœ‰æœ¬åœ°æ“ä½œæ­£å¸¸è¿è¡Œï¼ˆå°è´¦ uid ä½¿ç”¨ä¸´æ—¶ UIDï¼‰
- è”ç½‘åè‡ªåŠ¨è§¦å‘åŒ¿åç™»å½• â†’ è·å¾— Firebase UID
- æ‰¹é‡æ›´æ–°å°è´¦åŠæœ¬åœ°è¡¨ä¸­çš„ `uid` å­—æ®µï¼ˆå•æ¬¡ SQLite äº‹åŠ¡ï¼‰
- è¿™æ ·å³ä½¿å®Œå…¨ç¦»çº¿ï¼Œç”¨æˆ·ä¹Ÿèƒ½å®Œæˆ Onboarding â†’ åˆ›å»ºä¹ æƒ¯ â†’ è®¡æ—¶

### 1.4 çŸ­ ID ç”Ÿæˆ

**æ–°å»º**: `lib/core/utils/guest_id_generator.dart`

- 10 å­—ç¬¦ï¼Œå­—ç¬¦é›† `ABCDEFGHJKMNPQRSTUVWXYZ23456789`ï¼ˆæ’é™¤ 0/O/1/I/Lï¼‰
- FNV-1a å“ˆå¸Œ Firebase UID â†’ ç¡®å®šæ€§æ˜ å°„
- å­˜å…¥ Firestore `users/{uid}.guestId`

### 1.5 Provider æ–°å¢

**æ–‡ä»¶**: [auth_provider.dart](lib/providers/auth_provider.dart)

```dart
final isGuestProvider = Provider<bool>((ref) {
  return ref.watch(authStateProvider).value?.isAnonymous ?? false;
});

final guestIdProvider = FutureProvider<String?>((ref) { ... });
```

**æ–‡ä»¶**: [ai_provider.dart](lib/providers/ai_provider.dart)ï¼ˆæˆ–ç›¸å…³ä½ç½®ï¼‰

```dart
final aiAccessibleProvider = Provider<bool>((ref) {
  final aiReady = ref.watch(aiAvailabilityProvider) == AiAvailability.ready;
  final isGuest = ref.watch(isGuestProvider);
  return aiReady && !isGuest;
});
```

### 1.6 å¯¼èˆªæ¶æ„æ”¹é€ ï¼ˆ3 Tab + Drawerï¼‰

**æ ¸å¿ƒå˜æ›´**ï¼šä» 4 Tab ç¼©å‡ä¸º 3 Tabï¼ŒProfile ä»åº•éƒ¨ Tab ç§»å…¥ Drawerã€‚

**æ–‡ä»¶**: [home_screen.dart](lib/screens/home/home_screen.dart)

åº•éƒ¨å¯¼èˆªï¼š

| Tab | åç§° | å›¾æ ‡ | å±å¹• |
|-----|------|------|------|
| 0 | Today | `Icons.today` | `TodayTab`ï¼ˆä¸å˜ï¼‰ |
| 1 | çŒ«å±‹ | `Icons.pets` | `CatRoomScreen`ï¼ˆä¸å˜ï¼‰ |
| 2 | æˆå°± | `Icons.emoji_events` | `AchievementScreen`ï¼ˆä¸å˜ï¼‰ |

è§¦å‘æ–¹å¼ï¼šå·¦ä¸Šè§’å¤´åƒ `InkWell` æˆ–å·¦ä¾§è¾¹ç¼˜å³æ»‘ â†’ `Drawer`

**Today Tab æ”¹é€ **ï¼šåˆ é™¤ç°æœ‰çš„ `SummaryItem` ä¸‰è¿ï¼ˆæ€»åˆ†é’Ÿ/æ€»å°æ—¶/æ€»çŒ«æ•°ï¼‰ â€” è¿™äº›æ•°æ®å·²åœ¨æˆå°± Overview ä¸­æœ‰æ›´è¯¦ç»†çš„å±•ç¤ºã€‚Today Tab èšç„¦"ä»Šå¤©åšä»€ä¹ˆ"ã€‚

### 1.7 Drawer è®¾è®¡ï¼ˆM3 NavigationDrawerï¼‰

**æ–‡ä»¶**: æ–°å»º `lib/widgets/app_drawer.dart`ï¼ˆæ›¿ä»£ profile_screen.dart çš„å¤§éƒ¨åˆ†å†…å®¹ï¼‰

ä½¿ç”¨æ ‡å‡† `Drawer` + è‡ªå®šä¹‰ widget å¸ƒå±€ï¼ˆM3 `NavigationDrawer` é€‚ç”¨äºçº¯å¯¼èˆªç›®çš„åœ°ï¼Œä¸é€‚åˆæ··åˆå†…å®¹åœºæ™¯ï¼‰ï¼Œå†…å®¹åˆ†åŒºï¼š

**å·²ç™»å½•ç”¨æˆ·**ï¼š
```
â”Œâ”€ Drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                â”‚
â”‚  [Avatar 48dp]  Sinnoh                         â”‚
â”‚  sinnoh@gmail.com                              â”‚
â”‚  ğŸ· Marathon Catï¼ˆè£…å¤‡ç§°å·ï¼‰                    â”‚
â”‚                                                â”‚
â”‚  â”€â”€ é‡Œç¨‹ç¢‘ â”€â”€                                  â”‚
â”‚  â”Œâ”€ surfaceContainerHigh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ—“ åŠ å…¥ Hachimi 3 ä¸ªæœˆ                  â”‚  â”‚
â”‚  â”‚  ğŸ”¥ æœ€é•¿è¿ç»­ä¸“æ³¨ 2h 15m                  â”‚  â”‚
â”‚  â”‚  â­ æœ€æŠ•å…¥ä¹ æƒ¯ Learn Rust (45h)          â”‚  â”‚
â”‚  â”‚  ğŸ± çŒ«å’ªå®¶æ— 4 åªï¼Œ1 åªæ¯•ä¸šå…ƒè€          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚  â”€â”€ æˆ‘çš„ â”€â”€                                    â”‚
â”‚  ğŸ“Š ä¼šè¯å†å²                            >     â”‚
â”‚  ğŸ“… ç­¾åˆ°æ—¥å†                            >     â”‚
â”‚                                                â”‚
â”‚  âš™ï¸ è®¾ç½®                                 >     â”‚
â”‚                                                â”‚
â”‚  â”€â”€ è´¦å· â”€â”€                                    â”‚
â”‚  ğŸšª é€€å‡ºç™»å½•                                   â”‚
â”‚                                                â”‚
â”‚  v2.8.2 Â· æœ€ååŒæ­¥ 2 åˆ†é’Ÿå‰                    â”‚
â”‚  ID: HKXM47NB2R                       [copy]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¿å®¢ç”¨æˆ·**ï¼š
```
â”Œâ”€ Drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                â”‚
â”‚  [Avatar + Badge]  è®¿å®¢                        â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€ primaryContainer æ¨ªå¹… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ”— å…³è”è´¦å·ä»¥è§£é” AI åŠŸèƒ½å¹¶ä¿æŠ¤æ•°æ®     â”‚  â”‚
â”‚  â”‚                          [å…³è”è´¦å·]       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚  â”€â”€ é‡Œç¨‹ç¢‘ â”€â”€ï¼ˆåŒä¸Šï¼Œè®¿å®¢ä¹Ÿæœ‰ï¼‰                â”‚
â”‚                                                â”‚
â”‚  â”€â”€ æˆ‘çš„ â”€â”€                                    â”‚
â”‚  ğŸ“Š ä¼šè¯å†å²                            >     â”‚
â”‚  ğŸ“… ç­¾åˆ°æ—¥å†                            >     â”‚
â”‚                                                â”‚
â”‚  âš™ï¸ è®¾ç½®                                 >     â”‚
â”‚                                                â”‚
â”‚  â”€â”€ è´¦å· â”€â”€                                    â”‚
â”‚  âš ï¸ é€€å‡ºï¼ˆè®¿å®¢æ•°æ®å°†ä¸¢å¤±ï¼‰                     â”‚
â”‚                                                â”‚
â”‚  v2.8.2                                        â”‚
â”‚  ID: HKXM47NB2R                       [copy]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**M3 è®¾è®¡ç»†èŠ‚**ï¼š
- ä½¿ç”¨æ ‡å‡† `Drawer`ï¼ˆwidth: 360dp maxï¼‰+ è‡ªå®šä¹‰ `ListView` å¸ƒå±€
- å¤´åƒåŒºåŸŸï¼š`CircleAvatar`(24dp radius) + `titleMedium` åç§° + `bodySmall` email/guest status
- é‡Œç¨‹ç¢‘å¡ç‰‡ï¼š`surfaceContainerHigh` èƒŒæ™¯ + `AppShape.borderMedium` åœ†è§’
- é‡Œç¨‹ç¢‘æ•°æ®é€šè¿‡ `milestonesProvider`ï¼ˆ`FutureProvider`ï¼‰ç¼“å­˜ï¼Œç›‘å¬å°è´¦å˜æ›´è‡ªåŠ¨åˆ·æ–°ï¼Œé¿å…æ¯æ¬¡æ‰“å¼€ Drawer é‡å¤æŸ¥è¯¢
- åˆ†åŒºæ ‡é¢˜ï¼š`Padding` + `labelSmall` + `onSurfaceVariant`
- è®¾ç½®å…¥å£ï¼š**å•ä¸€ "è®¾ç½®" ListTile** â†’ è·³è½¬ç°æœ‰ `SettingsScreen`ï¼ˆä¸åœ¨ Drawer ä¸­é€é¡¹åˆ—ä¸¾ï¼‰
- çŸ­ ID + ç‰ˆæœ¬å·ï¼šåº•éƒ¨ `bodySmall` + `onSurfaceVariant`
- æœ€ååŒæ­¥æ—¶é—´ï¼šåº•éƒ¨ `bodySmall` + `onSurfaceVariant`ï¼ˆä½è°ƒæ˜¾ç¤ºï¼‰
- å¤´åƒ/åç§°å¯ç‚¹å‡» â†’ è§¦å‘ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆå¤ç”¨ç°æœ‰ `edit_name_dialog.dart` / `avatar_picker_sheet.dart`ï¼‰

**è®¿å®¢é€€å‡ºè­¦å‘Š**ï¼šM3 `AlertDialog` + `Icons.warning_rounded` + `colorScheme.error`
- æ˜ç¡®è¯´æ˜"é€€å‡ºåï¼Œå½“å‰æ•°æ®å°†æ— æ³•æ¢å¤"
- é€€å‡ºåæ¸…ç©ºæœ¬åœ° SQLite æ•°æ®åº“
- ä¸‰æŒ‰é’®ï¼š"å–æ¶ˆ" / "å…³è”è´¦å·"ï¼ˆæ¨èï¼‰/ "ä»ç„¶é€€å‡º"

### 1.7 AI åŠŸèƒ½ Teaser å¡ï¼ˆM3 è®¾è®¡ï¼‰

**æ–‡ä»¶**: [cat_detail_screen.dart](lib/screens/cat_detail/cat_detail_screen.dart)

è®¿å®¢è®¿é—®æ—¥è®°/èŠå¤©å…¥å£æ—¶ï¼Œä¸éšè—å¡ç‰‡ï¼Œè€Œæ˜¯æ˜¾ç¤º **é¢„è§ˆå¼•å¯¼æ€**ï¼ˆå±•ç¤ºä»·å€¼è€Œéé™åˆ¶ï¼‰ï¼š

```
â”Œâ”€ Card.outlined â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚  ğŸ“– çŒ«çŒ«æ—¥è®°                             â”‚
â”‚  â”Œâ”€ æ¨¡ç³Šé¢„è§ˆåŒº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  "ä»Šå¤©å’Œä¸»äººä¸€èµ·å­¦äº† Rust...      â”‚    â”‚  â† ShaderMask è™šåŒ–ï¼Œæš—ç¤ºå†…å®¹
â”‚  â”‚   æ„Ÿè§‰è‡ªå·±åˆå˜èªæ˜äº†å–µ~"          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  å…³è”è´¦å·ï¼Œçœ‹çœ‹ {catName} æƒ³è¯´ä»€ä¹ˆ       â”‚  â† bodySmall, primary color
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- `Card.outlined`ï¼ˆvs æ­£å¸¸çš„ `Card.filled`ï¼‰+ `ShaderMask` è™šåŒ–é¢„è§ˆæ–‡æœ¬
- å±•ç¤ºä¸€æ®µ**ç¤ºä¾‹æ—¥è®°å†…å®¹**ï¼ˆl10n æ¨¡æ¿ï¼‰ï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä»·å€¼
- CTA æ–‡æ¡ˆä½¿ç”¨æ­£å‘å¼•å¯¼è¯­ + `colorScheme.primary`
- ç‚¹å‡»è§¦å‘ **å‡çº§æç¤ºåº•éƒ¨å¼¹çª—**

### 1.8 å‡çº§æç¤ºï¼ˆM3 ModalBottomSheetï¼‰

**æ–°å»º**: `lib/widgets/guest_upgrade_prompt.dart`

å¤ç”¨ç°æœ‰ `AvatarPickerSheet` çš„ M3 æ¨¡å¼ï¼š

```dart
showModalBottomSheet(
  showDragHandle: true,
  constraints: BoxConstraints(maxWidth: AppBreakpoints.maxSheetWidth),
  // ...
  builder: (_) => SafeArea(child: _GuestUpgradeContent()),
);
```

å†…å®¹ï¼šå›¾æ ‡ + æ ‡é¢˜ + è¯´æ˜ + `FilledButton`ï¼ˆå…³è”è´¦å·ï¼‰+ `TextButton`ï¼ˆä»¥åå†è¯´ï¼‰

### 1.9 LoginScreen åŒæ¨¡å¼

**æ–‡ä»¶**: [login_screen.dart](lib/screens/auth/login_screen.dart) + [email_auth_screen.dart](lib/screens/auth/components/email_auth_screen.dart)

æ–°å¢ `linkMode` å‚æ•°ï¼š
- `linkMode=true`ï¼šæ ‡é¢˜æ”¹ä¸º"å…³è”è´¦å·"ï¼Œè°ƒç”¨ `linkWithGoogle/Email`
- æˆåŠŸå `markAccountLinked(uid)` + pop
- è·¯ç”±ä¼ å‚ï¼š[app_router.dart](lib/core/router/app_router.dart)

---

## Part 2ï¼šè¡Œä¸ºå°è´¦ï¼ˆAction Ledgerï¼‰

### 2.1 æ•°æ®æ¨¡å‹

æ‰©å±•ç°æœ‰ SQLite æ•°æ®åº“ï¼ˆ[local_database_service.dart](lib/services/local_database_service.dart)ï¼Œç‰ˆæœ¬ 1 â†’ 2ï¼‰ã€‚

**å…¨é‡æœ¬åœ°åŒ–ç­–ç•¥**ï¼šæ‰€æœ‰ä¸šåŠ¡æ•°æ®çš„ SSOT è¿ç§»åˆ°æœ¬åœ° SQLiteï¼ŒFirestore çº¯ç²¹ä½œä¸ºäº‘å¤‡ä»½ã€‚

```sql
-- â•â•â• è¡Œä¸ºå°è´¦ï¼šä¸å¯å˜äº‹ä»¶æ—¥å¿— â•â•â•
CREATE TABLE action_ledger (
  id TEXT PRIMARY KEY,              -- UUID v4
  type TEXT NOT NULL,               -- è¡Œä¸ºç±»å‹ï¼ˆè§ 2.2 æšä¸¾ï¼‰
  uid TEXT NOT NULL,                -- ç”¨æˆ· ID
  started_at INTEGER NOT NULL,      -- å¼€å§‹æ—¶é—´ï¼ˆepoch msï¼‰
  ended_at INTEGER,                 -- ç»“æŸæ—¶é—´ï¼ˆepoch msï¼Œç¬æ—¶æ“ä½œ = started_atï¼‰
  payload TEXT NOT NULL DEFAULT '{}', -- JSONï¼šæ“ä½œè¾“å…¥
  result TEXT NOT NULL DEFAULT '{}',  -- JSONï¼šäº§å‡ºï¼ˆé‡‘å¸/ç»éªŒå¢å‡ç­‰ï¼‰
  synced INTEGER NOT NULL DEFAULT 0,  -- 0=å¾…åŒæ­¥ 1=å·²åŒæ­¥ 2=æ°¸ä¹…å¤±è´¥ï¼ˆè¶…è¿‡é‡è¯•ä¸Šé™ï¼‰
  synced_at INTEGER,                -- åŒæ­¥å®Œæˆæ—¶é—´
  sync_attempts INTEGER NOT NULL DEFAULT 0, -- é‡è¯•æ¬¡æ•°
  sync_error TEXT,                  -- æœ€åä¸€æ¬¡åŒæ­¥å¤±è´¥çš„é”™è¯¯ä¿¡æ¯
  created_at INTEGER NOT NULL       -- è®°å½•åˆ›å»ºæ—¶é—´
);

CREATE INDEX idx_ledger_unsynced ON action_ledger(synced) WHERE synced = 0;
CREATE INDEX idx_ledger_uid_type ON action_ledger(uid, type, started_at);

-- â•â•â• é¢†åŸŸè¡¨ï¼šæœ¬åœ°ç‰©åŒ–çŠ¶æ€ï¼ˆæ›¿ä»£ Firestore å®æ—¶æµï¼‰â•â•â•

-- ä¹ æƒ¯è¡¨ â€” é•œåƒ Firestore users/{uid}/habits/{habitId}
CREATE TABLE local_habits (
  id TEXT PRIMARY KEY,
  uid TEXT NOT NULL,
  name TEXT NOT NULL,
  target_hours INTEGER,             -- null = æ°¸ç»­æ¨¡å¼
  goal_minutes INTEGER NOT NULL DEFAULT 25,
  reminders TEXT NOT NULL DEFAULT '[]',  -- JSON array of ReminderConfig
  motivation_text TEXT,
  cat_id TEXT,
  is_active INTEGER NOT NULL DEFAULT 1,
  total_minutes INTEGER NOT NULL DEFAULT 0,
  last_check_in_date TEXT,          -- 'yyyy-MM-dd'
  total_check_in_days INTEGER NOT NULL DEFAULT 0,
  deadline_date INTEGER,            -- epoch ms
  target_completed INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL
);

CREATE INDEX idx_habits_uid ON local_habits(uid, is_active);

-- çŒ«è¡¨ â€” é•œåƒ Firestore users/{uid}/cats/{catId}
CREATE TABLE local_cats (
  id TEXT PRIMARY KEY,
  uid TEXT NOT NULL,
  name TEXT NOT NULL,
  personality TEXT NOT NULL,
  appearance TEXT NOT NULL,          -- JSONï¼šCatAppearance å®Œæ•´åºåˆ—åŒ–
  total_minutes INTEGER NOT NULL DEFAULT 0,
  equipped_accessory TEXT,
  bound_habit_id TEXT NOT NULL,
  state TEXT NOT NULL DEFAULT 'active', -- active/graduated/dormant
  highest_stage TEXT,
  last_session_at INTEGER,          -- epoch ms
  created_at INTEGER NOT NULL
);

CREATE INDEX idx_cats_uid ON local_cats(uid, state);

-- ä¼šè¯è¡¨ â€” é•œåƒ Firestore users/{uid}/habits/{habitId}/sessions/{sessionId}
CREATE TABLE local_sessions (
  id TEXT PRIMARY KEY,
  uid TEXT NOT NULL,
  habit_id TEXT NOT NULL,
  cat_id TEXT NOT NULL,
  started_at INTEGER NOT NULL,
  ended_at INTEGER NOT NULL,
  duration_minutes INTEGER NOT NULL,
  target_duration_minutes INTEGER NOT NULL DEFAULT 0,
  paused_seconds INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL,             -- completed/abandoned/interrupted
  completion_ratio REAL NOT NULL DEFAULT 1.0,
  xp_earned INTEGER NOT NULL DEFAULT 0,
  coins_earned INTEGER NOT NULL DEFAULT 0,
  mode TEXT NOT NULL,               -- countdown/stopwatch
  checksum TEXT,
  client_version TEXT NOT NULL DEFAULT ''
);

CREATE INDEX idx_sessions_uid_habit ON local_sessions(uid, habit_id, started_at);
CREATE INDEX idx_sessions_date ON local_sessions(uid, started_at);

-- æœˆåº¦ç­¾åˆ°è¡¨ â€” é•œåƒ Firestore users/{uid}/monthlyCheckIns/{YYYY-MM}
CREATE TABLE local_monthly_checkins (
  uid TEXT NOT NULL,
  month TEXT NOT NULL,              -- 'yyyy-MM'
  checked_days TEXT NOT NULL DEFAULT '[]', -- JSON array of int
  total_coins INTEGER NOT NULL DEFAULT 0,
  milestones_claimed TEXT NOT NULL DEFAULT '[]', -- JSON array of int
  PRIMARY KEY (uid, month)
);

-- æ ‡é‡çŠ¶æ€è¡¨ â€” ç®€å• key-value å­˜å‚¨ï¼ˆé‡‘å¸ã€åº“å­˜ç­‰ï¼‰
CREATE TABLE materialized_state (
  uid TEXT NOT NULL,
  key TEXT NOT NULL,                -- 'coins', 'last_check_in_date', 'inventory' ç­‰
  value TEXT NOT NULL,              -- JSON å€¼
  updated_at INTEGER NOT NULL,
  PRIMARY KEY (uid, key)
);
```

**å¤æ‚å­—æ®µåºåˆ—åŒ–ç­–ç•¥**ï¼š
- `local_habits.reminders` â†’ JSON æ•°ç»„ï¼ˆå¤ç”¨ `ReminderConfig.toMap()`ï¼‰
- `local_cats.appearance` â†’ JSON å¯¹è±¡ï¼ˆå¤ç”¨ `CatAppearance.toJson()`ï¼‰
- `local_monthly_checkins.checked_days` â†’ JSON int æ•°ç»„
- `materialized_state.value` â†’ JSON æ ‡é‡æˆ–æ•°ç»„

**æ¨¡å‹å±‚å˜æ›´**ï¼šä¸º `Habit`ã€`Cat`ã€`FocusSession` æ·»åŠ  `toSqlite()` / `fromSqlite()` å·¥å‚æ–¹æ³•ï¼ˆä¸ç°æœ‰ `toFirestore()` / `fromFirestore()` å¯¹ç­‰ï¼‰ã€‚

### 2.2 è¡Œä¸ºç±»å‹å®šä¹‰

| type | payload ç¤ºä¾‹ | result ç¤ºä¾‹ |
|------|-------------|-------------|
| `check_in` | `{month:"2026-02", day:23, isWeekend:false}` | `{coins:+10, milestone:0}` |
| `focus_complete` | `{habitId, catId, minutes:25, mode:"countdown"}` | `{coins:+250, xp:+30, stageUp:false}` |
| `focus_abandon` | `{habitId, catId, minutes:8}` | `{coins:0, xp:0}` |
| `purchase` | `{accessoryId:"plant_01", price:50}` | `{coins:-50}` |
| `equip` | `{catId, accessoryId, previousId}` | `{}` |
| `unequip` | `{catId, accessoryId}` | `{}` |
| `habit_create` | `{habitId, catId, name}` | `{}` |
| `habit_update` | `{habitId, changes:{...}}` | `{}` |
| `habit_delete` | `{habitId}` | `{}` |
| `account_created` | `{method:"anonymous"}` | `{}` |
| `account_linked` | `{method:"google"}` | `{}` |

### 2.3 å†™å…¥æµç¨‹ï¼ˆå…³é”®ï¼ï¼‰

æ¯ä¸ªç”¨æˆ·æ“ä½œéƒ½éµå¾ªåŒä¸€æ¨¡å¼ â€” **åœ¨å•ä¸ª SQLite äº‹åŠ¡ä¸­åŒæ—¶å†™å°è´¦ + æ›´æ–°ç‰©åŒ–çŠ¶æ€**ï¼š

```dart
Future<CheckInResult?> checkIn(String uid) async {
  final db = await database;

  return db.transaction((txn) async {
    // 1. è¯»ç‰©åŒ–çŠ¶æ€ï¼ˆæœ¬åœ°ï¼Œæ— ç½‘ç»œï¼‰
    final lastDate = await _getMaterialized(txn, uid, 'last_check_in');
    if (lastDate == today) return null; // ä»Šæ—¥å·²ç­¾åˆ°

    final monthData = await _getMaterialized(txn, uid, 'monthly_$month');
    // ... è®¡ç®—å¥–åŠ±é€»è¾‘ï¼ˆçº¯ Dartï¼Œå¤ç”¨ç°æœ‰ coin_service çš„è®¡ç®—é€»è¾‘ï¼‰

    // 2. å†™å…¥è¡Œä¸ºå°è´¦ï¼ˆä¸å¯å˜è®°å½•ï¼‰
    await txn.insert('action_ledger', {
      'id': uuid.v4(),
      'type': 'check_in',
      'uid': uid,
      'started_at': now.millisecondsSinceEpoch,
      'ended_at': now.millisecondsSinceEpoch,
      'payload': jsonEncode({...}),
      'result': jsonEncode({'coins': dailyCoins, 'milestone': milestoneBonus}),
      'synced': 0,
      'created_at': now.millisecondsSinceEpoch,
    });

    // 3. æ›´æ–°ç‰©åŒ–çŠ¶æ€ï¼ˆåœ¨åŒä¸€ä¸ª SQLite äº‹åŠ¡ä¸­ï¼‰
    await _setMaterialized(txn, uid, 'coins', currentCoins + totalReward);
    await _setMaterialized(txn, uid, 'last_check_in', today);
    await _setMaterialized(txn, uid, 'monthly_$month', updatedMonthData);

    return CheckInResult(dailyCoins: dailyCoins, milestoneBonus: milestoneBonus);
  });
}
```

**å…³é”®ä¼˜åŠ¿**ï¼šå°è´¦å†™å…¥å’ŒçŠ¶æ€æ›´æ–°åœ¨åŒä¸€ä¸ª SQLite äº‹åŠ¡ä¸­ â€” è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å›æ»šã€‚ä¸ä¼šå‡ºç°"è®°äº†è´¦ä½†çŠ¶æ€æ²¡æ›´æ–°"æˆ–"çŠ¶æ€æ›´æ–°äº†ä½†æ²¡è®°è´¦"ã€‚

### 2.4 è¯»å–æµç¨‹

Provider ç›´æ¥ä»ç‰©åŒ–çŠ¶æ€è¯»å–ï¼ˆåŒæ­¥ã€é›¶å»¶è¿Ÿï¼‰ï¼š

```dart
final coinBalanceProvider = FutureProvider<int>((ref) async {
  final uid = ref.watch(currentUidProvider);
  if (uid == null) return 0;
  final ledger = ref.watch(ledgerServiceProvider);
  return ledger.getMaterializedInt(uid, 'coins') ?? 0;
});
```

**å¯¹æ¯”åŸæ–¹æ¡ˆ**ï¼š
- åŸæ–¹æ¡ˆï¼š`StreamProvider` ç›‘å¬ Firestore â†’ loading æ€ â†’ spinner â†’ æ•°æ®åˆ°è¾¾
- æ–°æ–¹æ¡ˆï¼š`FutureProvider` è¯»æœ¬åœ° SQLite â†’ å‡ ä¹ç¬æ—¶ â†’ æ—  spinnerï¼›Firestore æ•°æ®ä½œä¸ºåå°å¯¹è´¦

### 2.5 åå°åŒæ­¥å¼•æ“

**æ–°å»º**: `lib/services/sync_engine.dart`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SyncEngine                                      â”‚
â”‚                                                  â”‚
â”‚  è§¦å‘æ¡ä»¶ï¼š                                       â”‚
â”‚  1. App å¯åŠ¨ï¼ˆauth å®Œæˆåï¼‰                       â”‚
â”‚  2. connectivityProvider: offline â†’ online        â”‚
â”‚  3. æ–°è¡Œä¸ºå†™å…¥åï¼ˆdebounce 2sï¼‰                   â”‚
â”‚                                                  â”‚
â”‚  æµç¨‹ï¼š                                           â”‚
â”‚  1. SELECT * FROM action_ledger                  â”‚
â”‚     WHERE synced = 0 ORDER BY created_at LIMIT 20â”‚
â”‚  2. æŒ‰ type åˆ†å‘åˆ°å¯¹åº”çš„ Firestore å†™å…¥é€»è¾‘ï¼š     â”‚
â”‚     - check_in â†’ batch write (æœˆåº¦æ–‡æ¡£ + ç”¨æˆ·æ–‡æ¡£) â”‚
â”‚     - focus_complete â†’ batch write (session æ–‡æ¡£)  â”‚
â”‚     - purchase â†’ batch write (coins + inventory)  â”‚
â”‚     - equip/unequip â†’ batch write (cat + user)    â”‚
â”‚  3. å†™å…¥æˆåŠŸ â†’ UPDATE synced=1, synced_at=now     â”‚
â”‚  4. å†™å…¥å¤±è´¥ â†’ è·³è¿‡ï¼Œä¸‹æ¬¡é‡è¯•                     â”‚
â”‚  5. å…¨éƒ¨å¤„ç†å®Œ â†’ å¯é€‰ï¼šå¯¹è´¦ï¼ˆè§ 2.7ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰€æœ‰ Firestore å†™å…¥ç»Ÿä¸€ä½¿ç”¨ batch write**ï¼ˆé transactionï¼‰ï¼Œç¦»çº¿æ—¶ Firestore SDK è‡ªåŠ¨æ’é˜Ÿã€‚

**é‡è¯•ç­–ç•¥**ï¼š
- å°è´¦è¡¨å¢åŠ  `sync_attempts INTEGER DEFAULT 0` + `sync_error TEXT`
- ç¬æ—¶æ•…éšœï¼ˆç½‘ç»œæŠ–åŠ¨ï¼‰â†’ æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ2s â†’ 4s â†’ 8s â†’ ...ï¼‰
- æ°¸ä¹…æ•…éšœï¼ˆæƒé™ä¸è¶³ã€æ–‡æ¡£ç»“æ„é”™è¯¯ï¼‰â†’ è¶…è¿‡ 5 æ¬¡æ ‡è®° `sync_error`ï¼Œä¸å†é‡è¯•ï¼Œä»… `debugPrint` è®°å½•
- å†²çªï¼ˆæœåŠ¡ç«¯æ•°æ®å·²å˜æ›´ï¼‰â†’ è§¦å‘å¯¹è´¦æµç¨‹

**å°è´¦æ¸…ç†**ï¼šSyncEngine æ¯æ¬¡å®ŒæˆåŒæ­¥åï¼Œæ¸…ç†å·²åŒæ­¥ä¸”è¶…è¿‡ 90 å¤©çš„å°è´¦è®°å½•ï¼ˆç‰©åŒ–çŠ¶æ€å·²æŒä¹…ï¼Œå°è´¦ä»…ç”¨äºæº¯æºå’Œé‡æ”¾ï¼‰ã€‚

SyncEngine æ›¿ä»£äº†åŸæ–¹æ¡ˆä¸­çš„ï¼š
- `OfflineWriteGuard`ï¼ˆä¸å†éœ€è¦ï¼‰
- `offline_retry_registry.dart`ï¼ˆä¸å†éœ€è¦ï¼‰
- `local_state_service.dart`ï¼ˆä¸å†éœ€è¦ï¼‰
- `cached_stream_provider.dart`ï¼ˆä¸å†éœ€è¦ï¼‰

### 2.6 ç­¾åˆ° / é…é¥° / é‡‘å¸çš„æ”¹é€ 

å…¨éƒ¨ç»Ÿä¸€ä¸ºåŒä¸€æ¨¡å¼ï¼š**æœ¬åœ°å°è´¦å†™å…¥ + ç‰©åŒ–çŠ¶æ€æ›´æ–° + åå°åŒæ­¥**ã€‚

**ç­¾åˆ°**ï¼ˆæ›¿ä»£ `coin_service.checkIn()` çš„ transactionï¼‰ï¼š
- è¯»ç‰©åŒ–çŠ¶æ€ `last_check_in` â†’ åˆ¤æ–­æ˜¯å¦ä»Šå¤©å·²ç­¾åˆ°
- å†™å°è´¦ `check_in` + æ›´æ–°ç‰©åŒ–çŠ¶æ€ `coins`ã€`monthly_*`ã€`last_check_in`
- SyncEngine è´Ÿè´£åŒæ­¥åˆ° Firestore

**è´­ä¹°é…é¥°**ï¼ˆæ›¿ä»£ `coin_service.purchaseAccessory()` çš„ transactionï¼‰ï¼š
- è¯»ç‰©åŒ–çŠ¶æ€ `coins` â†’ æœ¬åœ°ä½™é¢æ ¡éªŒ
- å†™å°è´¦ `purchase` + æ›´æ–°ç‰©åŒ–çŠ¶æ€ `coins`ï¼ˆå‡ï¼‰ã€`inventory`ï¼ˆåŠ ï¼‰
- SyncEngine åŒæ­¥

**è£…å¤‡/å¸ä¸‹**ï¼ˆæ›¿ä»£ `inventory_service.equipAccessory()` çš„ transactionï¼‰ï¼š
- ç›´æ¥ä» UI ä¼ å…¥ `currentEquipped`ï¼ˆcatsProvider å·²æŒæœ‰ï¼‰
- å†™å°è´¦ `equip`/`unequip` + æ›´æ–°ç‰©åŒ–çŠ¶æ€ `inventory`ã€`cat_{id}_equipped`
- SyncEngine åŒæ­¥

**è®¡æ—¶å®Œæˆ**ï¼ˆå¢å¼ºç°æœ‰ `firestore_service.logFocusSession()` çš„ batch writeï¼‰ï¼š
- ç°æœ‰ batch write ä¿ç•™ï¼ˆå·²èƒ½ç¦»çº¿æ’é˜Ÿï¼‰
- é¢å¤–å†™å…¥å°è´¦ `focus_complete` è®°å½• â†’ æœ¬åœ°æœ‰å®Œæ•´è®°å½•

### 2.7 å¯¹è´¦æœºåˆ¶ï¼ˆReconciliationï¼‰

```
Firestore stream åˆ°æ¥æ—¶ï¼ˆhabitsProvider / catsProvider / coinBalanceProviderï¼‰ï¼š
  â†“
å¯¹æ¯”æœåŠ¡ç«¯å€¼ vs ç‰©åŒ–çŠ¶æ€å€¼ï¼š
  â”œâ”€â”€ ä¸€è‡´ â†’ æ— æ“ä½œ
  â”œâ”€â”€ æœåŠ¡ç«¯ > æœ¬åœ° â†’ å¯èƒ½å…¶ä»–æ¥æºå¢åŠ äº†ï¼ˆadmin/å¦ä¸€è®¾å¤‡ï¼‰â†’ æ›´æ–°ç‰©åŒ–çŠ¶æ€ä¸ºæœåŠ¡ç«¯å€¼
  â””â”€â”€ æœåŠ¡ç«¯ < æœ¬åœ° â†’ å¯èƒ½æœ¬åœ°æœ‰æœªåŒæ­¥çš„å˜æ›´ â†’ ä¿æŒæœ¬åœ°å€¼ï¼Œç­‰å¾… SyncEngine å®Œæˆ
```

Firestore StreamProvider ç»§ç»­å­˜åœ¨ï¼Œä½†è§’è‰²ä»"SSOT"å˜ä¸º"å¯¹è´¦å‚è€ƒ"ã€‚

### 2.8 Provider æ¶æ„å˜åŒ–ï¼ˆå…¨é‡æœ¬åœ°åŒ–ï¼‰

**æ‰€æœ‰ä¸šåŠ¡ Provider çš„ SSOT ä» Firestore è¿ç§»åˆ°æœ¬åœ° SQLite**ï¼š

| Provider | åŸæ–¹æ¡ˆï¼ˆFirestoreï¼‰ | æ–°æ–¹æ¡ˆï¼ˆSQLiteï¼‰ |
|----------|---------------------|------------------|
| `habitsProvider` | StreamProvider â†’ Firestore `.snapshots()` | StreamProvider â†’ SQLite `local_habits` è¡¨å˜æ›´é€šçŸ¥ |
| `catsProvider` | StreamProvider â†’ Firestore `.snapshots()` | StreamProvider â†’ SQLite `local_cats` è¡¨å˜æ›´é€šçŸ¥ |
| `todaySessionsProvider` | StreamProvider â†’ Firestore | FutureProvider â†’ SQLite `local_sessions` WHERE date=today |
| `coinBalanceProvider` | StreamProvider â†’ Firestore user doc | Provider â†’ SQLite `materialized_state` key='coins' |
| `hasCheckedInTodayProvider` | FutureProvider â†’ Firestore | Provider â†’ SQLite `materialized_state` key='last_check_in_date' |
| `monthlyCheckInProvider` | StreamProvider â†’ Firestore | FutureProvider â†’ SQLite `local_monthly_checkins` |
| `inventoryProvider` | StreamProvider â†’ Firestore | Provider â†’ SQLite `materialized_state` key='inventory' |

**å˜æ›´é€šçŸ¥æœºåˆ¶**ï¼š`LedgerService` åœ¨æ¯æ¬¡å†™å…¥åé€šè¿‡ `StreamController` å¹¿æ’­å˜æ›´äº‹ä»¶ã€‚Provider ç›‘å¬æ­¤ stream å¹¶ invalidate è‡ªèº«ï¼š

```dart
// LedgerService å†…éƒ¨
final _changeController = StreamController<LedgerChange>.broadcast();
Stream<LedgerChange> get changes => _changeController.stream;

// å†™å…¥åå¹¿æ’­
_changeController.add(LedgerChange(type: 'habit_create', affectedIds: [habitId]));
```

```dart
// habitsProvider ç›‘å¬å˜æ›´ï¼ˆä¸ä¾èµ– rxdartï¼Œä½¿ç”¨åŸç”Ÿ Stream + ref.invalidateSelfï¼‰
final habitsProvider = StreamProvider<List<Habit>>((ref) async* {
  final ledger = ref.watch(ledgerServiceProvider);
  final uid = ref.watch(currentUidProvider);
  if (uid == null) return;

  // åˆå§‹å€¼ï¼šç›´æ¥ä» SQLite è¯»å–
  yield await ledger.getHabits(uid);

  // ç›‘å¬å˜æ›´ï¼šLedgerService å¹¿æ’­äº‹ä»¶å yield æœ€æ–°æ•°æ®
  await for (final change in ledger.changes) {
    if (change.type.startsWith('habit_') || change.type == 'focus_complete') {
      yield await ledger.getHabits(uid);
    }
  }
});
```

> æ³¨ï¼šé¡¹ç›®ä¸ä¾èµ– rxdartï¼Œä½¿ç”¨ Dart åŸç”Ÿ `async*` generator + `await for` å®ç°åŒç­‰æ•ˆæœã€‚

**Firestore StreamProvider ä¿ç•™ä½†è§’è‰²è½¬å˜**ï¼š
- ä¸å†æ˜¯ UI çš„ç›´æ¥æ•°æ®æº
- ä»…åœ¨ SyncEngine ä¸­ç”¨äº**å¯¹è´¦**ï¼ˆä»æœåŠ¡ç«¯æ‹‰å–æœ€æ–°çŠ¶æ€ï¼Œä¸æœ¬åœ°æ¯”å¯¹ï¼‰
- å¯é€‰çš„"äº‘ç«¯åŒæ­¥ç›‘å¬"ï¼šå½“å…¶ä»–è®¾å¤‡ä¿®æ”¹æ•°æ®æ—¶ï¼Œé€šè¿‡ Firestore stream æ£€æµ‹åˆ°å˜æ›´å¹¶åˆå…¥æœ¬åœ°

### 2.9 åŒæ­¥ç­–ç•¥ï¼šå¯¹ç”¨æˆ·å®Œå…¨é€æ˜

**æ ¸å¿ƒåŸåˆ™**ï¼šç”¨æˆ·ä¸éœ€è¦çŸ¥é“ã€ç†è§£æˆ–æ“å¿ƒä»»ä½•åŒæ­¥ç›¸å…³çš„äº‹æƒ…ã€‚

- **ä¸å±•ç¤º** åŒæ­¥çŠ¶æ€å›¾æ ‡ã€Badgeã€è¿›åº¦æ¡
- **ä¸å±•ç¤º** "æœ€ååŒæ­¥æ—¶é—´"
- **ä¸å±•ç¤º** "å°†åœ¨è”ç½‘ååŒæ­¥" æç¤º
- **ä¸å±•ç¤º** å¾…åŒæ­¥æ•°é‡
- SyncEngine åœ¨åå°é™é»˜è¿è¡Œï¼ŒæˆåŠŸæˆ–å¤±è´¥éƒ½ä¸æ‰“æ‰°ç”¨æˆ·
- ç°æœ‰ `OfflineBanner` ä¿ç•™ï¼ˆå‘ŠçŸ¥ç”¨æˆ·"å½“å‰ç¦»çº¿"è¿™ä¸€äº‹å®æœ‰ä»·å€¼ï¼‰ï¼Œä½†ä¸æ¶‰åŠåŒæ­¥

SyncEngine å†…éƒ¨ä¿ç•™ `debugPrint` æ—¥å¿—ä¾›å¼€å‘è°ƒè¯•ï¼ŒUI å±‚ä»…åœ¨ **è®¾ç½®é¡µåº•éƒ¨**ï¼ˆç‰ˆæœ¬å·é™„è¿‘ï¼‰ä»¥ `bodySmall` + `onSurfaceVariant` ä½è°ƒæ˜¾ç¤º"æœ€ååŒæ­¥ï¼š2 åˆ†é’Ÿå‰"ã€‚ä¸ä½¿ç”¨å›¾æ ‡ã€ä¸ä½¿ç”¨é«˜äº®è‰²ã€ä¸è®¾ç½®ç‚¹å‡»è¡Œä¸º â€” çº¯æ–‡æœ¬ï¼Œä»…ä¾›æœ‰å¿ƒäººç¡®è®¤ã€‚

### 2.10 é¦–æ¬¡å¯åŠ¨ï¼ˆæ— å†å²åŒ…è¢±ï¼‰

é¡¹ç›®å°šæœªæ­£å¼å‘å¸ƒï¼Œ**ä¸éœ€è¦ä»»ä½•æ•°æ®è¿ç§»é€»è¾‘**ï¼š

- ä¸éœ€è¦ `migration_v2_service.dart`
- ä¸éœ€è¦ä» Firestore æ‹‰å–æ—§æ•°æ®
- DB ç‰ˆæœ¬ç›´æ¥è®¾ä¸º 2ï¼ˆæˆ– 1ï¼Œä»é›¶å¼€å§‹ï¼‰
- é¦–æ¬¡å¯åŠ¨ = ç©ºæ•°æ®åº“ â†’ ç”¨æˆ·ä» Onboarding å¼€å§‹ â†’ åŒ¿åç™»å½• â†’ åˆ›å»ºç¬¬ä¸€ä¸ªä¹ æƒ¯

---

## Part 3ï¼šæˆå°±ç³»ç»Ÿé—­ç¯æ”¹é€ 

### 3.1 å½“å‰é—®é¢˜

ç°æœ‰æˆå°±ç³»ç»Ÿï¼ˆ163 ä¸ªæˆå°±ï¼Œ4 ç±»åˆ«ï¼‰å­˜åœ¨ä¸¤ä¸ªç»“æ„æ€§ç¼ºé™·ï¼š

1. **è§¦å‘é å±å¹•æ‰‹åŠ¨è°ƒç”¨** â€” `triggerAchievementEvaluation` æ•£è½åœ¨ 4 ä¸ªå±å¹•ä¸­ï¼ˆtimer_screenã€adoption_flowã€check_in_bannerã€inventory_screenï¼‰ã€‚å¦‚æœä»£ç è·¯å¾„å˜æ›´æˆ–é—æ¼è°ƒç”¨ï¼Œæˆå°±å°±ä¸è§¦å‘ã€‚
2. **å­˜å‚¨åœ¨ Firestore** â€” `achievementService.evaluate()` ç”¨ batch write å†™ Firestore â†’ ç¦»çº¿å¤±è´¥ â†’ æˆå°±ä¸è§£é”ã€‚

### 3.2 æ–°æ¶æ„ï¼šäº‹ä»¶é©±åŠ¨ + æœ¬åœ°å­˜å‚¨

**æ ¸å¿ƒå˜æ›´**ï¼šæˆå°±è¯„ä¼°ä»"å±å¹•æ‰‹åŠ¨è§¦å‘"æ”¹ä¸º"å°è´¦äº‹ä»¶è‡ªåŠ¨é©±åŠ¨"ã€‚

```
ç”¨æˆ·æ“ä½œ â†’ LedgerService.append(action)
                â†“
         å¹¿æ’­ LedgerChange äº‹ä»¶
                â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AchievementEvaluator        â”‚  â† æ–°ç»„ä»¶ï¼Œç›‘å¬å°è´¦å˜æ›´
  â”‚ ï¼ˆæ›¿ä»£å±å¹•ä¸­çš„æ‰‹åŠ¨è§¦å‘ï¼‰       â”‚
  â”‚                             â”‚
  â”‚ 1. æ ¹æ® action.type ç¡®å®š    â”‚
  â”‚    éœ€è¦æ£€æŸ¥å“ªäº›æˆå°±          â”‚
  â”‚ 2. ä»æœ¬åœ°è¡¨è¯»å–å½“å‰çŠ¶æ€      â”‚
  â”‚ 3. è¯„ä¼°æ¡ä»¶ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰  â”‚
  â”‚ 4. è§£é” â†’ å†™å°è´¦ + æœ¬åœ°è¡¨   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AchievementCelebrationLayer â”‚  â† ç°æœ‰ç»„ä»¶ï¼Œç›‘å¬æ–°è§£é”
  â”‚ å¼¹å‡ºåº†ç¥å¡ç‰‡ï¼ˆä¿æŒä¸å˜ï¼‰      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**ï¼š
- ä»»ä½•å†™å…¥å°è´¦çš„æ“ä½œéƒ½è‡ªåŠ¨è§¦å‘æˆå°±æ£€æŸ¥ â€” é›¶é—æ¼
- æˆå°±è§£é”æœ¬èº«ä¹Ÿæ˜¯å°è´¦äº‹ä»¶ï¼ˆ`achievement_unlocked`ï¼‰â€” å®Œæ•´æº¯æº
- å…¨éƒ¨æœ¬åœ°æ“ä½œ â€” ç¦»çº¿æ­£å¸¸å·¥ä½œ
- å±å¹•ä¸­ä¸å†éœ€è¦è°ƒç”¨ `triggerAchievementEvaluation` â€” åˆ é™¤ 4 å¤„æ•£è½è°ƒç”¨

### 3.3 æœ¬åœ°æˆå°±è¡¨

```sql
CREATE TABLE local_achievements (
  id TEXT PRIMARY KEY,              -- æˆå°± IDï¼ˆå¦‚ 'quest_first_session'ï¼‰
  uid TEXT NOT NULL,
  unlocked_at INTEGER,              -- è§£é”æ—¶é—´ epoch msï¼ˆnull = æœªè§£é”ï¼‰
  reward_coins INTEGER NOT NULL DEFAULT 0,
  reward_claimed INTEGER NOT NULL DEFAULT 0, -- 0=æœªé¢†å– 1=å·²é¢†å–
  reward_claimed_at INTEGER,        -- é¢†å–æ—¶é—´ epoch ms
  title_reward TEXT,                -- ç§°å· IDï¼ˆnull = æ— ç§°å·ï¼‰
  trigger_action_id TEXT,           -- è§¦å‘è§£é”çš„å°è´¦ action UUID
  context TEXT DEFAULT '{}'         -- JSONï¼šè§£é”æ—¶çš„å¿«ç…§ï¼ˆç›¸å…³ç»Ÿè®¡æ•°æ®ï¼‰
);

CREATE INDEX idx_achievements_uid ON local_achievements(uid, unlocked_at);
```

**`context` å­—æ®µç¤ºä¾‹**ï¼š
```json
// quest_marathon è§£é”æ—¶çš„ context
{
  "sessionMinutes": 135,
  "habitName": "Learn Rust",
  "catName": "Mochi"
}

// persist_100 è§£é”æ—¶çš„ context
{
  "habitName": "Daily Reading",
  "totalCheckInDays": 100,
  "startedAt": "2026-01-15"
}
```

### 3.4 å°è´¦ä¸­çš„æˆå°±äº‹ä»¶

| type | payload | result |
|------|---------|--------|
| `achievement_unlocked` | `{achievementId, trigger: "focus_complete", triggerActionId}` | `{coins: +300, title: "marathon_cat"}` |
| `achievement_claimed` | `{achievementId}` | `{coins: 0}` |

> æ³¨ï¼šå½“å‰è®¾è®¡ä¸­ `rewardClaimed` åœ¨è§£é”æ—¶è‡ªåŠ¨è®¾ä¸º trueï¼ˆauto-claimï¼‰ã€‚ä½†æœ¬åœ°è¡¨é¢„ç•™äº† `reward_claimed` / `reward_claimed_at` å­—æ®µï¼Œä¸ºæœªæ¥çš„æ‰‹åŠ¨é¢†å–æµç¨‹ç•™å‡ºæ‰©å±•ç©ºé—´ã€‚å¦‚æœåç»­å¸Œæœ›ç”¨æˆ·æ‰‹åŠ¨"é¢†å–"å¥–åŠ±ï¼ˆè€Œéè‡ªåŠ¨å‘æ”¾ï¼‰ï¼Œåªéœ€ä¿®æ”¹ AchievementEvaluator çš„é€»è¾‘å³å¯ã€‚

### 3.5 æˆå°±è¯¦æƒ… Modalï¼ˆM3 è®¾è®¡ï¼‰

**æ–‡ä»¶**: [achievement_card.dart](lib/widgets/achievement_card.dart)ï¼ˆä¿®æ”¹ç‚¹å‡»è¡Œä¸ºï¼‰

ç”¨æˆ·ç‚¹å‡»ä»»æ„æˆå°±å¡ç‰‡ â†’ `showModalBottomSheet` æ˜¾ç¤ºè¯¦æƒ…ï¼š

**å·²è§£é”çŠ¶æ€**ï¼š
```
â”Œâ”€ ModalBottomSheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  [drag handle]                 â”‚
â”‚                                                â”‚
â”‚     ğŸ†  Marathon Focuser                       â”‚
â”‚     bodyLarge: å•æ¬¡ä¸“æ³¨ 120 åˆ†é’Ÿä»¥ä¸Š             â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€ surfaceContainerHigh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è§£é”æ—¶é—´   2026-02-15 14:32             â”‚  â”‚
â”‚  â”‚  è§¦å‘ä¼šè¯   Learn Rust Â· 135 åˆ†é’Ÿ         â”‚  â”‚
â”‚  â”‚  å¥–åŠ±       +300 é‡‘å¸ âœ“                   â”‚  â”‚
â”‚  â”‚  ç§°å·       Marathon Cat ğŸ·               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚                        [FilledButton.tonal]     â”‚
â”‚                        "å¤ªæ£’äº†"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœªè§£é”çŠ¶æ€ï¼ˆç´¯ç§¯å‹æˆå°±ï¼‰**ï¼š
```
â”Œâ”€ ModalBottomSheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  [drag handle]                 â”‚
â”‚                                                â”‚
â”‚     ğŸ”’  Centurion                              â”‚
â”‚     bodyLarge: ä»»æ„ä¹ æƒ¯ç´¯è®¡ 100 å°æ—¶             â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€ LinearProgressIndicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘  45h / 100h (45%)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚  å¥–åŠ±é¢„è§ˆ   +300 é‡‘å¸ + "Centurion" ç§°å·        â”‚
â”‚                                                â”‚
â”‚                        [TextButton]            â”‚
â”‚                        "ç»§ç»­åŠ æ²¹"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœªè§£é”çŠ¶æ€ï¼ˆè¿ç»­å‹æˆå°±ï¼Œå¦‚"è¿ç»­ç­¾åˆ° 7 å¤©"ï¼‰**ï¼š
```
â”Œâ”€ ModalBottomSheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  [drag handle]                 â”‚
â”‚                                                â”‚
â”‚     ğŸ”’  åšæŒä¸æ‡ˆ                               â”‚
â”‚     bodyLarge: è¿ç»­ç­¾åˆ° 7 å¤©                     â”‚
â”‚                                                â”‚
â”‚  å½“å‰è¿ç»­   3 å¤©                                â”‚
â”‚  æœ€ä½³è®°å½•   5 å¤©                                â”‚
â”‚                                                â”‚  â† ä¸ä½¿ç”¨è¿›åº¦æ¡ï¼Œé¿å…è¯¯å¯¼
â”‚  å¥–åŠ±é¢„è§ˆ   +100 é‡‘å¸                           â”‚
â”‚                                                â”‚
â”‚                        [TextButton]            â”‚
â”‚                        "ç»§ç»­åŠ æ²¹"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æˆå°±åˆ†ä¸º**ç´¯ç§¯å‹**ï¼ˆæ˜¾ç¤º `LinearProgressIndicator`ï¼‰å’Œ**è¿ç»­å‹**ï¼ˆæ˜¾ç¤ºå½“å‰å€¼ + æœ€ä½³è®°å½•ï¼Œä¸ç”¨è¿›åº¦æ¡ï¼‰ã€‚

**M3 ç»„ä»¶ä½¿ç”¨**ï¼š
- `showModalBottomSheet` + `showDragHandle: true` + `maxWidth: AppBreakpoints.maxSheetWidth`
- è¯¦æƒ…åŒºä½¿ç”¨ `surfaceContainerHigh` èƒŒæ™¯ + `AppShape.borderMedium` åœ†è§’
- è¿›åº¦æ¡ä½¿ç”¨ `LinearProgressIndicator`ï¼ˆM3 default stylingï¼‰
- æ—¶é—´æˆ³ä½¿ç”¨ `bodySmall` + `onSurfaceVariant`

### 3.6 AchievementEvaluator è§¦å‘æ˜ å°„

```dart
// å°è´¦ action.type â†’ éœ€è¦æ£€æŸ¥çš„æˆå°±è§¦å‘å™¨
const _triggerMap = {
  'focus_complete': AchievementTrigger.sessionCompleted,
  'habit_create': AchievementTrigger.habitCreated,
  'check_in': AchievementTrigger.checkInCompleted,
  'equip': AchievementTrigger.accessoryEquipped,
  'purchase': AchievementTrigger.accessoryEquipped, // è´­ä¹°åä¹Ÿæ£€æŸ¥é…é¥°ç›¸å…³
};
```

AchievementEvaluator ç›‘å¬ `LedgerService.changes`ï¼Œå¯¹åŒ¹é…çš„ action type è‡ªåŠ¨è¿è¡Œ `evaluate()`ã€‚è¯„ä¼°é€»è¾‘å¤ç”¨ç°æœ‰ `AchievementService._checkCondition()` çš„æ¡ä»¶åˆ¤æ–­ä»£ç ï¼Œä½†è¯»å–æºä» Firestore â†’ æœ¬åœ°è¡¨ã€‚

---

## Part 5ï¼šM3 è®¾è®¡å¢è¡¥

### 3.1 Loading çŠ¶æ€ä¼˜åŒ–

**æ ¸å¿ƒæ€è·¯**ï¼šç‰©åŒ–çŠ¶æ€æ¶ˆé™¤äº†é‡‘å¸/ç­¾åˆ°çš„ spinnerã€‚å¯¹äºä¹ æƒ¯/çŒ«åˆ—è¡¨ï¼Œä½¿ç”¨ä»¥ä¸‹æ¨¡å¼ï¼š

```dart
// ä»…åœ¨ç‰©åŒ–çŠ¶æ€ä¹Ÿæ— æ•°æ®æ—¶ï¼ˆçœŸæ­£çš„é¦–æ¬¡åŠ è½½ï¼‰æ‰æ˜¾ç¤º skeleton
final habits = habitsAsync.valueOrNull;
if (habits == null && !hasMaterializedData) {
  return SkeletonCard(); // ç°æœ‰ skeleton_loader.dart
}
return _buildHabitList(habits ?? materializedHabitsSummary);
```

### 3.2 é¦–æ¬¡å¯åŠ¨ Splashï¼ˆæ›¿ä»£ CircularProgressIndicatorï¼‰

åŒ¿åç™»å½•æœŸé—´æ˜¾ç¤º branded splash è€Œéè£¸ spinnerï¼š
- åº”ç”¨å›¾æ ‡ + åç§°
- M3 `LinearProgressIndicator`ï¼ˆ`colorScheme.primary`ï¼‰
- èƒŒæ™¯ï¼š`colorScheme.surface`

### 3.3 æ“ä½œåé¦ˆ

æ“ä½œæˆåŠŸåç»Ÿä¸€ä½¿ç”¨ M3 `SnackBar`ï¼ˆå·²æœ‰ floating é…ç½®ï¼‰ï¼š
- "ç­¾åˆ°æˆåŠŸ +10 é‡‘å¸" â€” åœ¨çº¿/ç¦»çº¿ä½¿ç”¨**å®Œå…¨ç›¸åŒçš„æ–‡æ¡ˆ**
- ä¸è¿½åŠ ä»»ä½•åŒæ­¥ç›¸å…³æç¤ºï¼ˆæ“ä½œå·²åœ¨æœ¬åœ°å®Œæˆ = æˆåŠŸï¼‰
- ä½¿ç”¨ `colorScheme.inverseSurface` + `onInverseSurface`

### 3.4 é¢œè‰²è¯­ä¹‰

| çŠ¶æ€ | Color Role | ç”¨é€” |
|------|-----------|------|
| è®¿å®¢èº«ä»½ | `secondary` / `secondaryContainer` | ä¿¡æ¯æ€§ï¼Œéä¸»è¦ |
| ç¦»çº¿ | `error` / `errorContainer` | OfflineBanner ä¿æŒä¸å˜ |
| åŒæ­¥ä¸­ | `tertiary` / `tertiaryContainer` | è¿‡ç¨‹æ€§ |
| AI é”å®š | `surfaceContainerLow` + `onSurfaceVariant` | å¼±åŒ– |

---

## å®Œæ•´æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ11 ä¸ªï¼‰

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `lib/core/utils/guest_id_generator.dart` | çŸ­ ID ç”Ÿæˆï¼ˆçº¯å‡½æ•°ï¼‰ |
| `lib/widgets/app_drawer.dart` | M3 NavigationDrawer â€” èº«ä»½ + é‡Œç¨‹ç¢‘ + è®¾ç½®å…¥å£ + è´¦å·ç®¡ç†ï¼ˆæ›¿ä»£ profile_screen.dartï¼‰ |
| `lib/widgets/guest_upgrade_prompt.dart` | è®¿å®¢å‡çº§æç¤º M3 ModalBottomSheet |
| `lib/services/ledger_service.dart` | è¡Œä¸ºå°è´¦æ ¸å¿ƒ â€” action_ledger å†™å…¥ + materialized_state CRUD + å˜æ›´å¹¿æ’­ |
| `lib/services/local_habit_repository.dart` | local_habits è¡¨ CRUD + é€šè¿‡ LedgerService å†™å°è´¦ |
| `lib/services/local_cat_repository.dart` | local_cats è¡¨ CRUD + é€šè¿‡ LedgerService å†™å°è´¦ |
| `lib/services/local_session_repository.dart` | local_sessions è¡¨ CRUD + é€šè¿‡ LedgerService å†™å°è´¦ |
| `lib/services/sync_engine.dart` | åå°é™é»˜åŒæ­¥å¼•æ“ â€” å°†æœªåŒæ­¥å°è´¦æ¡ç›®æ¨é€åˆ° Firestore |
| `lib/services/achievement_evaluator.dart` | äº‹ä»¶é©±åŠ¨æˆå°±è¯„ä¼°å™¨ â€” ç›‘å¬å°è´¦å˜æ›´è‡ªåŠ¨æ£€æŸ¥æˆå°± |
| `lib/models/ledger_action.dart` | LedgerAction æ•°æ®æ¨¡å‹ + ActionType æšä¸¾ |
| `lib/widgets/achievement_detail_sheet.dart` | æˆå°±è¯¦æƒ… M3 ModalBottomSheetï¼ˆè§£é”æ—¶é—´/è§¦å‘ä¸Šä¸‹æ–‡/å¥–åŠ±ï¼‰ |
| `lib/models/unlocked_achievement.dart` | æœ¬åœ°æˆå°±è®°å½•æ¨¡å‹ï¼ˆå« SQLite åºåˆ—åŒ–ï¼‰ |

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ~24 ä¸ªï¼‰

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| **æœåŠ¡å±‚** | |
| `lib/services/auth_service.dart` | +`signInAnonymously`, `linkWithGoogle`, `linkWithEmail`, `isAnonymous` |
| `lib/services/firestore_service.dart` | +`createGuestProfile`, `markAccountLinked`ï¼›é™çº§ä¸º SyncEngine å†…éƒ¨å®ç° |
| `lib/services/local_database_service.dart` | æ–°å¢ 7 å¼ è¡¨ï¼ˆaction_ledger + 6 é¢†åŸŸè¡¨ï¼‰ï¼›åˆ é™¤æ—§ç‰ˆè¿ç§»é€»è¾‘ |
| `lib/services/coin_service.dart` | `checkIn` / `purchaseAccessory` å§”æ‰˜ LedgerService |
| `lib/services/inventory_service.dart` | `equip/unequip` å§”æ‰˜ LedgerService |
| `lib/services/achievement_service.dart` | å­˜å‚¨ç›®æ ‡ä» Firestore â†’ æœ¬åœ°è¡¨ï¼›è¯„ä¼°é€»è¾‘æå–ä¾› evaluator å¤ç”¨ |
| **æ¨¡å‹å±‚** | |
| `lib/models/habit.dart` | +`toSqlite()`, `fromSqlite()` å·¥å‚æ–¹æ³• |
| `lib/models/cat.dart` | +`toSqlite()`, `fromSqlite()` å·¥å‚æ–¹æ³• |
| `lib/models/focus_session.dart` | +`toSqlite()`, `fromSqlite()` å·¥å‚æ–¹æ³• |
| `lib/models/monthly_check_in.dart` | +`toSqlite()`, `fromSqlite()` å·¥å‚æ–¹æ³• |
| **Provider å±‚** | |
| `lib/providers/auth_provider.dart` | +`isGuestProvider`, `guestIdProvider` |
| `lib/providers/ai_provider.dart` | +`aiAccessibleProvider` |
| `lib/providers/coin_provider.dart` | SSOT ä» Firestore â†’ SQLite materialized_state |
| `lib/providers/habits_provider.dart` | SSOT ä» Firestore â†’ SQLite local_habits + å˜æ›´ç›‘å¬ |
| `lib/providers/cat_provider.dart` | SSOT ä» Firestore â†’ SQLite local_cats + å˜æ›´ç›‘å¬ |
| `lib/providers/session_provider.dart` | SSOT ä» Firestore â†’ SQLite local_sessions |
| `lib/providers/achievement_provider.dart` | SSOT ä» Firestore â†’ SQLite local_achievements |
| **UI å±‚** | |
| `lib/app.dart` | AuthGate è‡ªåŠ¨åŒ¿åç™»å½• + branded splash |
| `lib/screens/auth/login_screen.dart` | +`linkMode` åŒæ¨¡å¼ |
| `lib/screens/auth/components/email_auth_screen.dart` | +`linkMode` |
| `lib/screens/home/home_screen.dart` | 4 Tab â†’ 3 Tab + Drawer è§¦å‘ |
| `lib/screens/home/components/today_tab.dart` | åˆ é™¤é‡å¤çš„ SummaryItem ä¸‰è¿ |
| `lib/screens/cat_detail/cat_detail_screen.dart` | AI é—¨æ§ â†’ M3 teaser å¡ |
| `lib/widgets/check_in_banner.dart` | è°ƒç”¨ ledger ç­¾åˆ° + å³æ—¶åé¦ˆ |
| `lib/widgets/achievement_card.dart` | ç‚¹å‡»æ‰“å¼€è¯¦æƒ… ModalBottomSheet |
| `lib/services/achievement_trigger_helper.dart` | åˆ é™¤æ•£è½çš„æ‰‹åŠ¨è§¦å‘è°ƒç”¨ï¼ˆç”± evaluator æ¥ç®¡ï¼‰ |
| `lib/core/router/app_router.dart` | login è·¯ç”±æ¥å— linkMode |
| `lib/l10n/app_en.arb` + `app_zh.arb` | è®¿å®¢/æˆå°±è¯¦æƒ…ç›¸å…³ l10n å­—ç¬¦ä¸² |

### åºŸå¼ƒ

| æ–‡ä»¶ | åŸå›  |
|------|------|
| `lib/core/utils/offline_write_guard.dart` | è¢« SyncEngine å®Œå…¨æ›¿ä»£ |
| `lib/services/achievement_trigger_helper.dart` | æ‰‹åŠ¨è§¦å‘é€»è¾‘è¢« AchievementEvaluator æ›¿ä»£ |
| `lib/screens/profile/profile_screen.dart` | åŠŸèƒ½è¿ç§»åˆ° `app_drawer.dart`ï¼›Profile ä¸å†æ˜¯åº•éƒ¨ Tab |
| `lib/screens/profile/components/` | edit_name_dialog / avatar_picker_sheet è¿ç§»åˆ° Drawer ç»„ä»¶ç›®å½• |

---

## å®æ–½é¡ºåº

> **DDD åŸåˆ™**ï¼šæ¯ä¸ª Phase å®Œæˆåï¼Œç«‹å³åŒæ­¥æ›´æ–°å¯¹åº”çš„ `docs/`ï¼ˆENï¼‰å’Œ `docs/zh-CN/`ï¼ˆä¸­æ–‡ï¼‰æ–‡æ¡£ã€‚æ–‡æ¡£å…ˆäºæˆ–åŒæ­¥äºä»£ç æ›´æ–°ï¼Œç»ä¸æ»åã€‚

### Phase 1ï¼šè¡Œä¸ºå°è´¦ + æœ¬åœ°è¡¨åŸºç¡€è®¾æ–½
1. `lib/models/ledger_action.dart` â€” ActionType æšä¸¾ + LedgerAction æ•°æ®æ¨¡å‹
2. `lib/models/` â€” habit/cat/focus_session/monthly_check_in æ·»åŠ  `toSqlite()` / `fromSqlite()`
3. `lib/models/unlocked_achievement.dart` â€” æœ¬åœ°æˆå°±è®°å½•æ¨¡å‹
4. `lib/services/local_database_service.dart` â€” æ–°å¢ 7 å¼ è¡¨ï¼ˆå°è´¦ + 6 é¢†åŸŸè¡¨ï¼‰
5. `lib/services/ledger_service.dart` â€” å°è´¦å†™å…¥ + materialized_state CRUD + å˜æ›´å¹¿æ’­
6. `lib/services/local_habit_repository.dart` + `local_cat_repository.dart` + `local_session_repository.dart` â€” é¢†åŸŸè¡¨ CRUD
7. å•å…ƒæµ‹è¯•ï¼šå°è´¦å†™å…¥åŸå­æ€§ã€SQLite äº‹åŠ¡å›æ»šã€ç‰©åŒ–çŠ¶æ€ä¸€è‡´æ€§
8. **æ–‡æ¡£æ›´æ–°**ï¼š
   - `docs/architecture/data-model.md` + `docs/zh-CN/architecture/data-model.md` â€” æ–°å¢ SQLite è¡¨ç»“æ„ï¼ˆaction_ledger + 6 é¢†åŸŸè¡¨ + materialized_stateï¼‰ã€åºåˆ—åŒ–ç­–ç•¥ã€å°è´¦å†™å…¥æµç¨‹
   - `docs/architecture/folder-structure.md` + `docs/zh-CN/architecture/folder-structure.md` â€” æ–°å¢ ledger_serviceã€local_*_repository æ–‡ä»¶è¯´æ˜
   - `docs/architecture/overview.md` + `docs/zh-CN/architecture/overview.md` â€” æ¶æ„æ¦‚è§ˆå¢åŠ "æœ¬åœ°ä¼˜å…ˆ + è¡Œä¸ºå°è´¦"æ®µè½

### Phase 2ï¼šProvider å±‚è¿ç§»ï¼ˆSSOT â†’ SQLiteï¼‰
9. `lib/providers/habits_provider.dart` â€” Firestore â†’ SQLite
10. `lib/providers/cat_provider.dart` â€” Firestore â†’ SQLite
11. `lib/providers/coin_provider.dart` â€” Firestore â†’ SQLite
12. `lib/providers/session_provider.dart` â€” Firestore â†’ SQLite
13. `lib/providers/achievement_provider.dart` â€” Firestore â†’ SQLite
14. éªŒè¯ï¼šæ‰€æœ‰å±å¹•æ­£å¸¸æ˜¾ç¤ºæ•°æ®
15. **æ–‡æ¡£æ›´æ–°**ï¼š
    - `docs/architecture/state-management.md` + `docs/zh-CN/architecture/state-management.md` â€” Provider å›¾è°±æ›´æ–°ï¼ˆSSOT ä» Firestore â†’ SQLiteï¼‰ï¼Œå˜æ›´é€šçŸ¥æœºåˆ¶è¯´æ˜ï¼ŒFirestore é™çº§ä¸º"å¯¹è´¦å‚è€ƒ"

### Phase 3ï¼šä¸šåŠ¡æ“ä½œæ”¹é€ 
16. `lib/services/coin_service.dart` â€” checkIn / purchaseAccessory â†’ LedgerService
17. `lib/services/inventory_service.dart` â€” equip/unequip â†’ LedgerService
18. `lib/widgets/check_in_banner.dart` â€” ä½¿ç”¨æœ¬åœ°ç­¾åˆ°
19. Timer å®Œæˆæµç¨‹ â€” å†™å…¥å°è´¦ + æœ¬åœ°è¡¨
20. ä¹ æƒ¯åˆ›å»º/æ›´æ–°/åˆ é™¤ â€” å†™å…¥å°è´¦ + æœ¬åœ°è¡¨
21. æ‰‹åŠ¨æµ‹è¯•ï¼šé£è¡Œæ¨¡å¼å…¨æµç¨‹
22. **æ–‡æ¡£æ›´æ–°**ï¼š
    - `docs/architecture/focus-completion.md` + `docs/zh-CN/architecture/focus-completion.md` â€” è®¡æ—¶å®Œæˆæµç¨‹å¢åŠ å°è´¦å†™å…¥æ­¥éª¤
    - `docs/architecture/cat-system.md` + `docs/zh-CN/architecture/cat-system.md` â€” çŒ«æˆé•¿/é…é¥°æ“ä½œæ”¹ä¸ºå°è´¦é©±åŠ¨

### Phase 4ï¼šæˆå°±ç³»ç»Ÿé—­ç¯
23. `lib/services/achievement_evaluator.dart` â€” äº‹ä»¶é©±åŠ¨è¯„ä¼°å™¨
24. `lib/services/achievement_service.dart` â€” å­˜å‚¨ç›®æ ‡æ”¹ä¸ºæœ¬åœ°
25. `lib/widgets/achievement_detail_sheet.dart` â€” æˆå°±è¯¦æƒ… Modal
26. `lib/widgets/achievement_card.dart` â€” ç‚¹å‡»æ‰“å¼€è¯¦æƒ…
27. åˆ é™¤ `achievement_trigger_helper.dart` ä¸­çš„æ•£è½è§¦å‘è°ƒç”¨
28. éªŒè¯ï¼šå®Œæˆä¸€æ¬¡è®¡æ—¶ â†’ æˆå°±è‡ªåŠ¨è§¦å‘ â†’ åº†ç¥å¼¹çª— â†’ è¯¦æƒ…å¯æŸ¥
29. **æ–‡æ¡£æ›´æ–°**ï¼š
    - `docs/architecture/data-model.md` â€” æ–°å¢ local_achievements è¡¨è¯´æ˜ + æˆå°±äº‹ä»¶ç±»å‹
    - `docs/architecture/overview.md` â€” æˆå°±ç³»ç»Ÿä»"å±å¹•æ‰‹åŠ¨è§¦å‘"æ”¹ä¸º"å°è´¦äº‹ä»¶é©±åŠ¨"

### Phase 5ï¼šåŒæ­¥å¼•æ“ï¼ˆé™é»˜åå°ï¼‰
30. `lib/services/sync_engine.dart` â€” åå°é™é»˜åŒæ­¥ + connectivity è§¦å‘ + æŒ‡æ•°é€€é¿é‡è¯• + å°è´¦æ¸…ç†
31. `lib/app.dart` â€” åœ¨ auth å®Œæˆåå¯åŠ¨ SyncEngine
32. **æ–‡æ¡£æ›´æ–°**ï¼š
    - `docs/architecture/overview.md` â€” æ–°å¢"åŒæ­¥å¼•æ“"æ®µè½ï¼ˆè§¦å‘æ¡ä»¶ã€é‡è¯•ç­–ç•¥ã€å¯¹è´¦æœºåˆ¶ï¼‰
    - `docs/firebase/security-rules.md` + `docs/zh-CN/firebase/security-rules.md` â€” å¦‚æœ‰è§„åˆ™å˜æ›´éœ€åŒæ­¥

### Phase 6ï¼šå¯¼èˆªé‡æ„ + è®¿å®¢æ¨¡å¼
33. `lib/screens/home/home_screen.dart` â€” 4 Tab â†’ 3 Tab + Drawer è§¦å‘
34. `lib/widgets/app_drawer.dart` â€” M3 NavigationDrawerï¼ˆèº«ä»½ + é‡Œç¨‹ç¢‘ + è®¾ç½® + è´¦å·ï¼‰
35. `lib/screens/home/components/today_tab.dart` â€” åˆ é™¤é‡å¤ SummaryItem ä¸‰è¿
36. `lib/core/utils/guest_id_generator.dart` â€” çŸ­ ID
37. `lib/services/auth_service.dart` â€” æ–°å¢ 4 ä¸ªæ–¹æ³•ï¼ˆsignInAnonymouslyã€linkWithGoogleã€linkWithEmailã€isAnonymousï¼‰
38. `lib/app.dart` â€” AuthGate è‡ªåŠ¨åŒ¿åç™»å½• + branded splash + ç¦»çº¿å›é€€ï¼ˆä¸´æ—¶æœ¬åœ° UIDï¼‰
39. `lib/widgets/guest_upgrade_prompt.dart` â€” å‡çº§æç¤º
40. `lib/screens/auth/login_screen.dart` + `email_auth_screen.dart` â€” linkMode
41. `lib/screens/cat_detail/cat_detail_screen.dart` â€” AI teaser é—¨æ§ï¼ˆè™šåŒ–é¢„è§ˆï¼‰
42. åºŸå¼ƒ `lib/screens/profile/` â€” åŠŸèƒ½å·²è¿å…¥ Drawer
43. **æ–‡æ¡£æ›´æ–°**ï¼š
    - `docs/architecture/overview.md` â€” å¯¼èˆªæ¶æ„ä» 4 Tab æ”¹ä¸º 3 Tab + Drawerï¼›æ–°å¢"è®¿å®¢æ¨¡å¼"æ®µè½
    - `docs/design/screens.md` + `docs/zh-CN/design/screens.md` â€” Drawer è®¾è®¡è§„æ ¼ã€è®¿å®¢æ€ã€AI teaser å¡
    - `docs/firebase/security-rules.md` â€” åŒ¿åç”¨æˆ· Firestore è®¿é—®è§„åˆ™
    - `docs/product/user-stories.md` + `docs/zh-CN/product/user-stories.md` â€” æ–°å¢è®¿å®¢ç”¨æˆ·æ•…äº‹

### Phase 7ï¼šL10n & æ”¶å°¾
44. `lib/l10n/app_en.arb` + `app_zh.arb` â€” è®¿å®¢/æˆå°±è¯¦æƒ…/Drawer ç›¸å…³ l10n å­—ç¬¦ä¸²
45. å…¨é¢ç¦»çº¿ç«¯åˆ°ç«¯æµ‹è¯•
46. åºŸå¼ƒ OfflineWriteGuard + achievement_trigger_helper
47. **æ–‡æ¡£æ›´æ–°**ï¼ˆæ”¶å°¾å…¨é¢æ ¡éªŒï¼‰ï¼š
    - `docs/architecture/localization.md` â€” æ–°å¢ l10n key æ¸…å•
    - `docs/architecture/folder-structure.md` â€” å®Œæ•´æ–‡ä»¶æ¸…å•ç»ˆæ ¡
    - `docs/architecture/tech-debt-analysis.md` â€” æ ‡è®°å·²è§£å†³çš„æŠ€æœ¯å€ºï¼ˆç¦»çº¿ transaction å¤±è´¥ã€æˆå°±è§¦å‘æ•£è½ã€SP ç¼“å­˜åæ¨¡å¼ï¼‰
    - `docs/zh-CN/` â€” å…¨éƒ¨å¯¹åº”ä¸­æ–‡æ–‡æ¡£åŒæ­¥æ›´æ–°
    - `CLAUDE.md` â€” SSOT è¡¨æ–°å¢ LedgerServiceã€SyncEngine ç›¸å…³æ¡ç›®

---

## éªŒè¯æ–¹æ¡ˆ

### è¡Œä¸ºå°è´¦æµ‹è¯•
1. æŸ¥çœ‹ SQLite å°è´¦ï¼šæ¯æ¬¡ç­¾åˆ°/è®¡æ—¶/è´­ä¹°/åˆ›å»ºä¹ æƒ¯/è£…å¤‡åï¼Œ`action_ledger` ä¸­æœ‰å¯¹åº” UUID è®°å½•
2. ç‰©åŒ–çŠ¶æ€ä¸€è‡´æ€§ï¼š`materialized_state.coins` = åˆå§‹å€¼ + æ‰€æœ‰å°è´¦ `result.coins` çš„ç´¯åŠ 
3. æœ¬åœ°è¡¨ä¸€è‡´æ€§ï¼š`local_habits` / `local_cats` ä¸å°è´¦ä¸­çš„åˆ›å»º/æ›´æ–°/åˆ é™¤æ“ä½œåŒ¹é…
4. ç¦»çº¿æ“ä½œï¼šé£è¡Œæ¨¡å¼ä¸‹ç­¾åˆ° â†’ å°è´¦ `synced=0` â†’ æ¢å¤ç½‘ç»œ â†’ SyncEngine â†’ `synced=1`
5. App æ€æ‰é‡å¯ï¼šå°è´¦å’Œæœ¬åœ°è¡¨æŒä¹…åœ¨ SQLite â†’ æ— æ•°æ®ä¸¢å¤±
6. å°è´¦å¯é‡æ”¾ï¼šåˆ é™¤ `materialized_state` + æœ¬åœ°è¡¨æ•°æ® â†’ ä» `action_ledger` é‡å»º â†’ çŠ¶æ€ä¸€è‡´

### å¯¼èˆªæ¶æ„æµ‹è¯•
1. åº•éƒ¨ä»… 3 ä¸ª Tabï¼ˆToday / çŒ«å±‹ / æˆå°±ï¼‰ï¼Œæ—  Profile Tab
2. å·¦ä¸Šè§’å¤´åƒå¯ç‚¹å‡» â†’ Drawer å¼¹å‡º â†’ åŒ…å«èº«ä»½/é‡Œç¨‹ç¢‘/è®¾ç½®/è´¦å·
3. å·¦ä¾§è¾¹ç¼˜å³æ»‘ â†’ åŒæ ·è§¦å‘ Drawer
4. Drawer é‡Œç¨‹ç¢‘åŒºåŸŸæ˜¾ç¤ºåŠ¨æ€è®¡ç®—çš„ä¸ªäººæ•°æ®ï¼ˆåŠ å…¥æ—¶é—´/æœ€é•¿ä¼šè¯/æœ€æŠ•å…¥ä¹ æƒ¯/çŒ«å’ªå®¶æ—ï¼‰
5. Drawer â†’ "è®¾ç½®" â†’ è¿›å…¥ SettingsScreenï¼ˆé€šçŸ¥/å¤–è§‚/è¯­è¨€/AI å‡åœ¨ SettingsScreen å†…ï¼‰
6. å¤´åƒ/åç§°å¯ç‚¹å‡» â†’ ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆå¤ç”¨ç°æœ‰ç»„ä»¶ï¼‰
7. Tablet æ¨¡å¼ä¸‹ Drawer æ­£å¸¸é€‚é…

### è®¿å®¢æ¨¡å¼æµ‹è¯•
1. å…¨æ–°å®‰è£… â†’ Onboarding â†’ è‡ªåŠ¨è¿›å…¥é¦–é¡µï¼ˆæ— ç™»å½•å±å¹•ï¼‰
2. Drawer æ˜¾ç¤º"è®¿å®¢" + å…³è”è´¦å·æ¨ªå¹… + åº•éƒ¨çŸ­ ID
3. çŒ«æ—¥è®°/èŠå¤©å…¥å£ â†’ M3 teaser å¡ï¼ˆè™šåŒ–é¢„è§ˆ + æ­£å‘å¼•å¯¼æ–‡æ¡ˆï¼‰â†’ ç‚¹å‡»å¼¹å‡ºå‡çº§æç¤º
4. Drawer â†’ å…³è” Google â†’ Drawer æ˜¾ç¤ºé‚®ç®±å’Œåç§° â†’ AI åŠŸèƒ½è§£é” â†’ åº†ç¥åŠ¨ç”»
5. å…³è”åæ‰€æœ‰æ•°æ®ä¿ç•™ï¼ˆåŒä¸€ UIDï¼Œå°è´¦è®°å½• `account_linked`ï¼‰
6. è®¿å®¢é€€å‡º â†’ è­¦å‘Šå¯¹è¯æ¡†ï¼ˆä¸‰æŒ‰é’®ï¼‰â†’ "ä»ç„¶é€€å‡º" â†’ æ¸…ç©ºæœ¬åœ°æ•°æ® â†’ æ–°åŒ¿åè´¦å·

### ç«¯åˆ°ç«¯ç¦»çº¿æµ‹è¯•
1. é£è¡Œæ¨¡å¼ â†’ åˆ›å»ºä¹ æƒ¯ï¼ˆå«çŒ«ï¼‰+ ç­¾åˆ° + è´­ä¹°é…é¥° + è£…å¤‡ + è®¡æ—¶å®Œæˆ â†’ å…¨éƒ¨å³æ—¶å“åº”
2. æ¢å¤ç½‘ç»œ â†’ `debugPrint` æ—¥å¿—è§‚å¯Ÿ SyncEngine é€æ¡æ¨é€ â†’ Firestore æ•°æ®å®Œæ•´
3. å†·å¯åŠ¨æ— ç½‘ç»œ â†’ æœ¬åœ°è¡¨å³æ—¶å¯ç”¨ â†’ ä¹ æƒ¯åˆ—è¡¨ã€çŒ«æˆ¿é—´ã€é‡‘å¸ã€ç­¾åˆ°å…¨éƒ¨æ­£ç¡®
4. å…¨æ–°å®‰è£…æ— ç½‘ç»œ â†’ Onboarding â†’ åŒ¿åç™»å½•å¤±è´¥ â†’ æ˜¾ç¤ºé‡è¯•å±å¹• â†’ è”ç½‘åè‡ªåŠ¨è¿›å…¥

### è¿è¡Œå‘½ä»¤
```bash
dart analyze lib/
flutter test
flutter build apk --debug
# å®‰è£…åˆ°æµ‹è¯•è®¾å¤‡åï¼Œæ‰‹åŠ¨æ‰§è¡Œä»¥ä¸Šåœºæ™¯
```

---

## å®æ–½å‰ç½®ä»»åŠ¡

> ä»¥ä¸‹ä»»åŠ¡åœ¨è®¡åˆ’æ‰¹å‡†åã€ä»£ç å®æ–½å‰ç«‹å³æ‰§è¡Œï¼š

1. **å½’æ¡£æœ¬è®¡åˆ’** â†’ `docs/plan/20260224-000000-guest-mode-local-first-architecture.md`
2. **æ›´æ–° CLAUDE.md** â€” SSOT è¡¨æ–°å¢ï¼š
   - `å¼€å‘è®¡åˆ’å½’æ¡£` â†’ `docs/plan/`
3. **æ›´æ–° CLAUDE.md** â€” æ–°å¢"å¼€å‘è®¡åˆ’å½’æ¡£è§„èŒƒ"æ®µè½ï¼š
   - æ‰€æœ‰ PLAN æ¨¡å¼äº§å‡ºçš„å¼€å‘è®¡åˆ’å¿…é¡»ä¿å­˜åˆ° `docs/plan/`
   - æ–‡ä»¶å‘½åï¼š`{YYYYMMDD-HHMMSS}-{kebab-case-title}.md`ï¼ˆåŒ—äº¬æ—¶é—´æ—¶é—´æˆ³ï¼‰
   - æ¯æ¬¡è¿›å…¥ PLAN æ¨¡å¼æ—¶è‡ªåŠ¨è¯»å–æ­¤è§„èŒƒï¼Œæ— éœ€ç”¨æˆ·é‡å¤æé†’
