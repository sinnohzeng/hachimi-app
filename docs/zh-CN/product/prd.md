# 产品需求文档（PRD，Product Requirements Document）v3.0

> **版本**：3.0 | **状态**：已实现 | **最后更新**：2026-02-17

---

## 1. 产品愿景

**Hachimi** 是一款养猫习惯应用。你创建的每一个习惯都会带来一只独特的虚拟小猫咪。专注于习惯可以赚取 XP（经验值），XP 让猫咪成长。随着习惯增加，温馨的猫咪房间会越来越热闹——成为你成长历程的生动记录。

**核心循环：**

```
创建习惯 → 领养幼猫 → 开始专注计时 → 赚取 XP → 猫咪进化
```

**设计理念：** 抽象的习惯追踪在情感上是中性的。一只在你跳过打卡时会思念你的猫咪则不然。Hachimi 运用依附心理和养育心理，将坚持从义务转化为关怀。

---

## 2. 目标用户

**主要用户：** 18-35 岁的目标导向型个体，特征如下：

- 正在长期学习或练习一项技能（语言学习、编程、健身、创意写作等）
- 已了解连续打卡的价值，但难以坚持
- 对视觉反馈和进度可视化有积极响应
- 熟悉移动端应用和轻度游戏化机制

**非目标用户：** 寻求严格时间盒（番茄钟类应用）、社交问责或企业团队追踪的用户。

---

## 3. 功能规范

### 3.1 引导流程

**流程：**

1. **3 页走马灯**，介绍猫咪循环核心：
   - 第 1 页：「欢迎来到 Hachimi」—— Emoji 🐱，应用概念
   - 第 2 页：「专注赚取 XP」—— Emoji ⏱️，计时器 + XP 说明
   - 第 3 页：「看着它们进化」—— Emoji ✨，阶段进化预览
2. **登录/注册** —— 邮箱 + 密码，或 Google OAuth
3. **首个习惯领养** —— 自动检测：若 `habits.length == 0`，重定向至领养流程并显示首次用户提示

**验收标准：**

- 引导完成状态存储于 `SharedPreferences`（键：`onboarding_complete`，类型：bool）
- 完成后，`AuthGate` 不再显示引导界面
- 首次用户自动进入领养流程；已有习惯的用户直接进入主界面

---

### 3.2 用户认证

| 方式 | 状态 |
|------|------|
| 邮箱 + 密码 | 支持 |
| Google OAuth | 支持 |

**行为：**

- 会话跨应用重启持久保持（Firebase Auth 本地持久化）
- 退出登录时，导航至 `LoginScreen` 并清除所有 Provider 状态
- 首次登录时创建用户文档 `users/{uid}`

---

### 3.3 习惯管理

**创建习惯**（领养流程 —— 3 个步骤）：

**第 1 步 —— 定义习惯：**

- 习惯名称（必填，文本框）
- Emoji 图标（约 30 个精选选项的 Emoji 选择器）
- 每日专注目标：片段选择器 `[15 分钟] [25 分钟] [40 分钟] [60 分钟] [自定义]`，默认 25 分钟
- 提醒时间：可选，快速选择片段（「7 点」「8 点」「21 点」「不提醒」）

**第 2 步 —— 领养猫咪：**

- 并排显示 3 只候选猫咪
- 每张卡片显示：品种名称、性格徽章、性格语录、猫咪精灵预览
- 点击选择，未选中的卡片淡出
- 猫咪由 `CatGenerationService.generateDraft()` 生成

**第 3 步 —— 给猫咪命名：**

- 文本框，预填来自 `catNames` 池的随机名字
- 「领养」按钮 → 批量写入 Firestore（习惯 + 猫咪）→ 导航至主界面
- 领养成功时播放彩纸动画

**删除习惯：**

- 习惯被永久删除
- 绑定猫咪在同一 Firestore 批次中转换为 `graduated`（毕业）状态
- 已毕业猫咪在猫咪相册中保持可见（显示为灰色）

---

### 3.4 专注计时器

**计时器模式：**

- **倒计时**：用户设置目标时长，计时器倒数。圆形进度环逐渐缩小。
- **正计时**：开放式，计时器正数。进度环相对于习惯的 `goalMinutes` 填充。

**专注设置界面：**

- 猫咪居中突出显示（大图）
- 时长片段：`[15] [25] [40] [60] [自定义]`，默认为习惯的 `goalMinutes`
- 模式切换：`SegmentedButton`（「倒计时」/「正计时」）
- 「开始专注」按钮

**计时器界面（进行中）：**

- 全屏，柔和渐变背景（猫咪品种颜色）
- 猫咪精灵居中显示
- 猫咪外围圆形进度环
- 计时器显示（剩余时间或已用时间）
- 顶部显示习惯名称 + 连续记录徽章
- **长按**「放弃」按钮以确认（防止误操作）

**后台行为：**

- Android 前台服务保持应用最小化时计时器持续运行
- 持久通知显示：猫咪 Emoji + 习惯名称 + 剩余/已用时间
- 后台超时处理：
  - 离开 < 15 秒：正常继续
  - 离开 15 秒至 5 分钟：自动暂停
  - 离开 > 5 分钟：自动结束会话

**会话完成：**

- XP 由 `XpService.calculateXp()` 计算
- 会话通过 `FirestoreService.logFocusSession()` 原子批量写入 Firestore
- 导航至专注完成界面

**放弃会话：**

- 已专注 ≥ 5 分钟：会话以 `completed: false` 保存，仅获得基础 XP
- 已专注 < 5 分钟：不保存会话，不获得 XP

---

### 3.5 XP 与猫咪进化

完整 XP 公式及阶段阈值详见 [猫咪系统](../architecture/cat-system.md)。

**XP 公式：**

```
totalXp = (分钟数 × 1) + streakBonus + milestoneBonus + fullHouseBonus
```

| 组成部分 | 数值 | 条件 |
|---------|------|------|
| 基础 XP | 1 XP / 分钟 | 始终 |
| 连击奖励 | +5 / 会话 | currentStreak ≥ 3 |
| 里程碑奖励 | +30（一次性） | 连续记录达到 7、14 或 30 天 |
| 全家福奖励 | +10 / 会话 | 今日所有习惯均已完成 |

来自 Remote Config 的 XP 倍率（键：`xp_multiplier`，默认值 `1.0`）用于活动期间缩放总 XP。

**成长阶段：**

| 阶段 | XP 阈值 | 外观 |
|------|---------|------|
| 幼猫 🐱 | 0 | 小巧圆润的精灵 |
| 少年猫 🐈 | 100 | 成长中，更有表情 |
| 成年猫 🐈‍⬛ | 300 | 完全成形 |
| 闪光猫 ✨🐈 | 600 | 金色光芒效果 |

**专注完成界面：**

- 猫咪弹跳动画 + 「+{xp} XP」浮动文字
- 若阶段进化，则播放关键帧切换动画
- 统计数据：时长、获得 XP、当前连续记录、累计总 XP
- 今日完成所有习惯时显示「全家福！」特效

---

### 3.6 猫咪房间

猫咪房间是应用的情感核心，展示所有活跃猫咪在温馨插画房间场景中的生活状态。

**布局：**

- 房间背景图（根据系统时间区分白天/夜晚：6:00-19:59 为白天，其余为夜晚）
- 最多 10 只猫咪摆放在预设槽位坐标处（详见 [猫咪系统](../architecture/cat-system.md)）
- 每只猫咪精灵以品种颜色着色

**交互：**

- 点击猫咪 → 出现对话气泡（性格 × 心情文案）+ 底部弹窗
- 底部弹窗操作：「开始专注」→ FocusSetupScreen；「查看详情」→ CatDetailScreen
- 对话气泡在 3 秒后或点击背景时消失

**溢出：** 若用户有 >10 只活跃猫咪，显示「查看全部 {n} 只猫咪 →」链接，打开完整猫咪相册。

---

### 3.7 推送通知

| 类型 | 触发条件 | 通知渠道 | 文案 |
|------|---------|---------|------|
| 每日提醒 | 按 `habit.reminderTime` 定时触发 | `hachimi_reminders` | 「{猫咪名字} 在等你！是时候专注 {习惯名称} 了。」 |
| 连续记录风险 | 20:00 本地时间，今日无会话且连续记录 ≥ 3 天 | `hachimi_reminders` | 「不要断掉你 {n} 天的连续记录！{猫咪名字} 开始担心你了。」 |
| 升级庆祝 | 阶段进化后立即触发 | `hachimi_focus` | 「{猫咪名字} 进化到 {阶段} 了！快来看看！」 |
| 召回通知 | 超过 48 小时无会话（FCM） | `hachimi_reminders` | 「{猫咪名字} 很想你。已经 {n} 天了……」 |

---

## 4. 导航

**4 标签 NavigationBar：**

| 标签 | 图标 | 界面 |
|------|------|------|
| 今日 | home | HomeScreen —— 精选猫咪 + 习惯列表 |
| 猫咪房间 | pets | CatRoomScreen —— 插画房间，所有猫咪 |
| 统计 | bar_chart | StatsScreen —— 活动热力图 + 各习惯统计 |
| 我的 | person | ProfileScreen —— 设置 + 猫咪相册 |

---

## 5. 分析策略

**转化漏斗：**

```
app_open → sign_up → cat_adopted → focus_session_started → focus_session_completed → cat_level_up
```

完整事件规范详见 [分析事件](../firebase/analytics-events.md)。

---

## 6. A/B 测试

| 键 | 默认值 | 变体 | 目标指标 |
|---|--------|------|---------|
| `xp_multiplier` | `1.0` | 1.0 vs 1.5 | `focus_session_completed` 完成率 |
| `notification_copy_variant` | `"A"` | A、B | 通知打开率 |
| `mood_threshold_lonely_days` | `3` | 3 vs 5 | 间隔后会话返回率 |
| `default_focus_duration` | `25` | 25 vs 15 | 会话启动率 |

---

## 7. 范围之外（v3.0）

- 社交功能（分享、排行榜、好友）
- 深色模式手动切换（由系统控制，使用 `ThemeMode.system`）
- App Store / Play Store 提交
- 离线优先 / 本地缓存（Firestore 离线持久化为隐式支持）
- 数据导出
- 多设备同步（FCM Token 每账号仅支持一台设备）
- 猫咪配件 / 外观商城
- 多人 / 协作习惯追踪
- Web 或桌面端支持
