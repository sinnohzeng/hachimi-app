# 猫咪系统 — 游戏设计 SSOT（单一真值来源）

> **SSOT（Single Source of Truth，单一真值来源）**：本文档是所有猫咪游戏机制的单一权威来源。`lib/core/constants/cat_constants.dart` 的实现必须与本规范完全一致。

---

## 概览

猫咪系统是 Hachimi 的情感核心。它将抽象的习惯追踪转化为一种养育体验：你坚持的每一个习惯都会培育出一只独特的虚拟伙伴。该系统的设计目标：

1. **奖励坚持** —— XP（经验值）、升级和心情改善通过定期专注获得
2. **建立依附** —— 独特的品种、性格和名字让每只猫咪都感觉是你的
3. **可视化进步** —— 猫咪进化为习惯连续记录提供清晰、有情感共鸣的反馈
4. **随雄心扩展** —— 猫咪房间最多同时容纳 10 只活跃猫咪；猫咪相册数量无限制

---

## 品种

共有 **10 种品种**，每种品种有稀有度权重和用于精灵着色的色板。

| 品种 ID | 显示名称 | 稀有度 | 权重 | 基础色 | 强调色 |
|---------|---------|--------|------|--------|--------|
| `orange_tabby` | 橘猫 | 普通 | 20 | `#FF8C00` | `#FFA500` |
| `grey_shorthair` | 灰短毛猫 | 普通 | 18 | `#808080` | `#A9A9A9` |
| `white_persian` | 白波斯猫 | 普通 | 16 | `#FFFAFA` | `#E8E8E8` |
| `black_cat` | 黑猫 | 不普通 | 12 | `#2D2D2D` | `#4A4A4A` |
| `calico` | 三花猫 | 不普通 | 10 | `#E8A87C` | `#F4C2A1` |
| `siamese` | 暹罗猫 | 不普通 | 10 | `#C8A882` | `#B8926A` |
| `tuxedo` | 燕尾服猫 | 不普通 | 8 | `#1C1C1C` | `#FFFFFF` |
| `bengal` | 孟加拉猫 | 稀有 | 3 | `#C68E4A` | `#D4A254` |
| `russian_blue` | 俄罗斯蓝猫 | 稀有 | 2 | `#7A9BB5` | `#8FAFC7` |
| `golden_tabby` | 金虎斑猫 | 稀有 | 1 | `#DAA520` | `#FFD700` |

**总权重：100。** 抽卡采用加权随机抽取；如可能，每次抽卡中至少有 1 种用户尚未拥有的品种。

### 花纹（每品种 3 种，共 30 种）

每种品种有 3 种花纹，纯为外观设计，不影响游戏进度：

```
classic_stripe（经典条纹）、spotted（斑点）、solid（纯色）
```

花纹在领养时随机分配，概率相等。

---

## 性格

共有 **6 种性格**，每种性格影响：

- 房间槽位偏好
- 对话气泡文案
- 待机动画键（未来功能）

| 性格 ID | 显示名称 | Emoji | 偏好槽位 | 性格语录 |
|---------|---------|-------|---------|---------|
| `lazy` | 慵懒 | 😴 | sofa、bed | 「嘘……再睡五分钟……」 |
| `curious` | 好奇 | 🔍 | shelf、windowsill | 「今天外面有什么新鲜事？」 |
| `playful` | 活泼 | 🎮 | rug、desk | 「玩！玩！玩！」 |
| `shy` | 害羞 | 🙈 | corner、box | 「哦！没想到你在这里……」 |
| `brave` | 勇敢 | 🦁 | door、chair | 「这个地方交给我守护！」 |
| `clingy` | 黏人 | 🤗 | food_bowl、rug | 「别走！陪我待在这里！」 |

性格在领养时随机分配。

---

## 成长阶段

猫咪根据累计 XP 经历 **4 个阶段**：

| 阶段 | ID | 名称 | Emoji | XP 阈值 | 描述 |
|------|-----|------|-------|---------|------|
| 1 | `kitten` | 幼猫 | 🐱 | 0 XP | 刚出生，小小的，充满潜力 |
| 2 | `young` | 少年猫 | 🐈 | 100 XP | 快速成长，更有表情 |
| 3 | `adult` | 成年猫 | 🐈‍⬛ | 300 XP | 完全成形，充满自信 |
| 4 | `shiny` | 闪光猫 | ✨🐈 | 600 XP | 稀有进化形态，金色光芒效果 |

**阶段计算** 在读取时从 `xp` 派生，不单独存储于 Firestore（防止漂移）。计算属性 `cat.computedStage` 始终返回权威阶段。

**阶段进度**（用于 XP 进度条）：
```
progress = (xp - 当前阶段阈值) / (下一阶段阈值 - 当前阶段阈值)
```
达到最高阶段（闪光猫）时，进度始终为 `1.0`。

---

## 心情系统

猫咪心情根据 `lastSessionAt`（最近一次专注会话的时间戳）计算。心情 **不存储** 于 Firestore（在读取时重新计算，以始终反映当前现实）。

| 心情 ID | 名称 | Emoji | 条件 | 表现 |
|---------|------|-------|------|------|
| `happy` | 开心 | 😸 | 最近会话在 24 小时内 | 默认显示，猫咪活泼 |
| `neutral` | 平静 | 😐 | 最近会话在 1-3 天内 | 略显低落 |
| `lonely` | 孤独 | 😿 | 最近会话在 3-7 天内 | 悲伤精灵，担忧的话语 |
| `missing` | 思念 | 💔 | 最近会话超过 7 天 | 非常悲伤，触发召回通知 |

> Remote Config（远程配置）键 `mood_threshold_lonely_days`（默认值：3）控制孤独阈值（天数）。

**心情影响：**

- 猫咪精灵选择（开心/平静/悲伤姿势变体）
- 对话气泡文字内容
- 猫咪房间氛围（休眠猫咪显示为淡化状态）

---

## 对话气泡文案

对话文案遵循 「性格：心情」矩阵。每种组合有 1-3 条文案变体，当前实现每种组合返回一条。

| | `happy` | `neutral` | `lonely` | `missing` |
|--|---------|-----------|---------|---------|
| `lazy` | 「今天是睡懒觉的完美时光……」 | 「唔，我还好吧。」 | 「我好怀念我们一起懒散的日子……」 | 「你去哪了？我的地方都凉了……」 |
| `curious` | 「今天我有了新发现！」 | 「一切都……还算正常吧。」 | 「我好奇你最近在探索什么……」 | 「你忘了我们的冒险了吗？」 |
| `playful` | 「一起玩！一起玩！」 | 「我等着玩耍……」 | 「没有人陪我玩太难过了……」 | 「求你回来陪我玩……」 |
| `shy` | 「哦！你来了！（脸红）」 | 「我一直在安静地等待……」 | 「我担心你忘记我了……」 | 「我好想你，都快心疼了……」 |
| `brave` | 「我一直在守护这里！」 | 「还在巡逻中。」 | 「没有你，这个家感觉空荡荡的。」 | 「我很勇敢地等了你这么久……」 |
| `clingy` | 「别走！陪我待着！」 | 「我需要更多抱抱……」 | 「求你别让我独处……」 | 「我把每一秒都数了遍……」 |

---

## XP 系统

XP 在每次专注会话结束时获得。所有计算在 `XpService`（纯 Dart，无 Firebase 依赖）中完成。

### XP 公式

```
totalXp = baseXp + streakBonus + milestoneBonus + fullHouseBonus
```

| 组成部分 | 公式 | 条件 |
|---------|------|------|
| `baseXp`（基础 XP） | `分钟数 × 1` | 始终 |
| `streakBonus`（连击奖励） | `+5` / 会话 | `currentStreak >= 3` |
| `milestoneBonus`（里程碑奖励） | `+30` 一次性 | 连续记录达到 7、14 或 30 天 |
| `fullHouseBonus`（全家福奖励） | `+10` / 会话 | 今日所有习惯均已完成 |

来自 Remote Config 的 XP 倍率（键：`xp_multiplier`，默认值：`1.0`）用于活动期间缩放 `totalXp`。

### 放弃会话

提前结束（放弃）的会话，若用户专注时间 **≥ 5 分钟** 仍可获得 XP：

- XP = `已专注分钟数 × 1`（仅基础部分，无连击或奖励 XP）
- 会话在 Firestore 中标记为 `completed: false`

---

## 房间槽位系统

猫咪房间有 **11 个命名槽位**，每个槽位有对应的坐标（X%，Y%）：

| 槽位 ID | 显示名称 | X% | Y% | 自然居住者 |
|---------|---------|----|----|-----------|
| `sofa` | 沙发 | 0.68 | 0.42 | lazy、clingy |
| `windowsill` | 窗台 | 0.65 | 0.12 | curious、brave |
| `rug` | 地毯 | 0.45 | 0.62 | playful、clingy |
| `desk` | 桌子 | 0.20 | 0.30 | playful、curious |
| `shelf` | 书架 | 0.12 | 0.18 | curious、shy |
| `food_bowl` | 猫粮盆 | 0.08 | 0.75 | clingy、lazy |
| `door` | 门口 | 0.85 | 0.55 | brave |
| `chair` | 椅子 | 0.35 | 0.40 | brave、shy |
| `bed` | 床 | 0.15 | 0.60 | lazy |
| `corner` | 角落 | 0.05 | 0.85 | shy |
| `box` | 纸箱 | 0.55 | 0.80 | shy、playful |

**槽位分配算法：**

1. 从 `CatPersonality.preferredRoomSlots` 收集该性格偏好的槽位
2. 过滤出空闲（未被占用）的槽位
3. 若无偏好槽位空闲，则回退到任意空闲槽位
4. 若所有槽位均被占用（活跃猫咪 >11 只），溢出的猫咪会被隐藏（显示在「查看全部」相册中）

槽位以 `roomSlot`（String?）字段 **存储** 于 Firestore 的猫咪文档中。在领养时分配，重新摆放时可更新。

---

## 猫咪生成（抽卡算法）

`CatGenerationService.generateDraft()` 方法为领养流程生成 3 只候选猫咪：

```
generateDraft(userOwnedBreeds, boundHabitId) → List<Cat>（长度 = 3）
```

**算法：**

1. 从 `catBreeds` 构建加权品种池（稀有度权重之和为 100）
2. 通过 **不重复的加权随机抽取** 选出 3 种品种（同一次抽卡内无重复）
3. 若用户已拥有所有品种，则跳过唯一性要求；否则保证至少 1 种用户尚未拥有的品种
4. 为每种品种分配随机花纹（概率相等）、随机性格（概率相等），从品种计算稀有度，从 `catNames` 池生成随机名字
5. 返回 3 个 `Cat` 对象，初始状态：`state: 'active'`、`xp: 0`、`stage: 1`、`mood: 'happy'`，无 `id`（由 Firestore 在创建时分配）

---

## 猫咪状态

| 状态 | 含义 | 显示 |
|------|------|------|
| `active` | 绑定活跃习惯，出现在猫咪房间 | 全色显示 |
| `dormant` | 习惯已停用，猫咪在休息 | 略微淡化 |
| `graduated` | 习惯已删除，猫咪永久移入相册 | 灰化，统计数据冻结 |

状态转换：

- `active` → `dormant`：习惯标记为不活跃
- `active` → `graduated`：习惯被删除（`FirestoreService` 中的 `deleteHabit`）
- `dormant` → `active`：习惯重新激活（未来功能）

---

## 猫咪相册

猫咪相册（`allCatsProvider` —— 包含所有状态）显示：

- **活跃**猫咪：全色显示，可点击跳转至猫咪房间位置
- **休眠**猫咪：70% 不透明度
- **毕业**猫咪：50% 不透明度，显示「已毕业」标签

猫咪按 `createdAt` 降序排列（最近领养的排在最前）。
