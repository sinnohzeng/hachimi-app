# Contributing Guide

Thank you for contributing to Hachimi! This document describes the development workflow, conventions, and standards for working on this project.

---

## Development Principles

This project follows **Document-Driven Development (DDD)**:

1. **Document first**: Before implementing a feature, update the relevant specification in `docs/`.
2. **Code is the implementation**: If code and docs conflict, fix the code.
3. **SSOT everywhere**: Every concern has exactly one authoritative source. Do not duplicate logic across files.
4. **No speculative features**: Only build what's specified. Do not add configuration options, abstractions, or flexibility "just in case."

---

## Prerequisites

| Tool | Version | Install |
|------|---------|---------|
| Flutter | 3.41.x | `flutter upgrade` |
| Dart | 3.11.x | Bundled with Flutter |
| JDK | 17 | `brew install openjdk@17` (macOS) |
| Firebase CLI | Latest | `npm install -g firebase-tools` |
| FlutterFire CLI | Latest | `dart pub global activate flutterfire_cli` |

After cloning:
```bash
flutter pub get
flutterfire configure --project=hachimi-ai  # generates firebase_options.dart
```

---

## Branch Naming

| Type | Pattern | Example |
|------|---------|---------|
| Feature | `feat/<short-description>` | `feat/cat-room-scene` |
| Bug fix | `fix/<short-description>` | `fix/timer-background-crash` |
| Documentation | `docs/<short-description>` | `docs/update-data-model` |
| Refactor | `refactor/<short-description>` | `refactor/xp-service-cleanup` |
| Chore | `chore/<short-description>` | `chore/upgrade-agp` |

Branch from `main`. All work happens on feature branches; merge via PR.

---

## Commit Messages

Follow the [Conventional Commits](https://www.conventionalcommits.org/) specification:

```
<type>(<scope>): <short summary>

[optional body]

[optional footer]
```

**Types:** `feat`, `fix`, `docs`, `refactor`, `test`, `chore`, `style`

**Examples:**
```
feat(cat-room): add personality-based slot placement algorithm
fix(timer): prevent duplicate session writes on rapid Give Up tap
docs(data-model): add sessions subcollection schema
chore: upgrade AGP to 8.13.2
```

---

## Code Style

Run the linter before every commit:
```bash
flutter analyze
```

Zero warnings, zero errors is required. If `flutter analyze` fails, do not open a PR.

**Key style rules:**
- Use `const` wherever the compiler will accept it
- Prefer `final` over `var`
- No `print()` in production code — use `debugPrint()` or remove before PR
- No commented-out code — delete it; git history preserves it
- Follow the layer dependency rules in [Folder Structure](architecture/folder-structure.md)

---

## Adding a New Feature

1. **Update docs** — find the relevant spec document (e.g., `cat-system.md` for cat mechanics, `prd.md` for product features) and update it.
2. **Update data model** if Firestore schema changes — update `data-model.md` and `firestore.rules`.
3. **Update analytics** if new user actions need tracking — update `analytics-events.md` and `analytics_events.dart`.
4. **Implement** — follow the existing patterns in the relevant layer (model → service → provider → screen/widget).
5. **Run `flutter analyze`** — fix all warnings.
6. **Test manually** — use the verification plan from the implementation plan if one exists.

---

## Adding a New Screen

1. Create file in `lib/screens/{feature}/` following `snake_case.dart` naming.
2. Create a `class {FeatureName}Screen extends ConsumerWidget`.
3. Add the route to `AppRouter` and document in `overview.md` navigation table.
4. Update `screens.md` with the new screen spec.

---

## Adding a New Provider

1. Create file in `lib/providers/` or add to existing related provider file.
2. Document the new provider in `state-management.md` — type, source, consumers, SSOT for.
3. Ensure providers follow the graph rules: no circular dependencies, no Screens in providers.

---

## Firebase Rules Changes

1. Update `firestore.rules` at project root.
2. Update `docs/firebase/security-rules.md` to reflect the change.
3. Test using the Firebase Console Rules Simulator.
4. Deploy: `firebase deploy --only firestore:rules`

---

## Pull Request Checklist

Before requesting review:

- [ ] `flutter analyze` passes with 0 warnings
- [ ] Relevant docs updated (spec, data model, analytics, etc.)
- [ ] No hardcoded colors, fonts, or spacing values
- [ ] No direct Service imports in Screen files
- [ ] New analytics events added to both `analytics_events.dart` and `analytics-events.md`
- [ ] Firestore schema changes reflected in both `firestore.rules` and `data-model.md`

---

## Gitignored Files

These files are **never committed**:
- `lib/firebase_options.dart` — generated by `flutterfire configure`
- `android/app/google-services.json` — Firebase Android config
- `ios/Runner/GoogleService-Info.plist` — Firebase iOS config

Each contributor generates these locally by running `flutterfire configure` with their Firebase project.

---

## Useful Commands

```bash
# Run app on connected device
flutter run

# Build APK (for manual ADB install)
flutter build apk

# Install APK directly via ADB (vivo/some devices)
adb install -r -t -d build/app/outputs/flutter-apk/app-debug.apk

# Lint
flutter analyze

# Format code
dart format lib/

# Enable Firebase Analytics DebugView
adb shell setprop debug.firebase.analytics.app com.hachimi.hachimi_app

# Deploy Firestore rules
firebase deploy --only firestore:rules

# Clear app data (useful for testing first-launch flows)
adb shell pm clear com.hachimi.hachimi_app
```
