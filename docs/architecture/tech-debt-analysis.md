# Tech Debt Analysis

> **Purpose**: Documents identified technical debt, AI coding artifacts, and improvement recommendations for the Hachimi codebase.
> **Status**: Active

---

## 1. Error Handling (RESOLVED)

### Problem

28+ catch blocks across 12 service files used only `debugPrint` for error logging. Errors were invisible in production — Crashlytics only captured Flutter framework-level fatal errors (via `FlutterError.onError`), missing all service-layer exceptions.

**Before:**
```dart
} catch (e) {
  debugPrint('[CoinService] checkIn: $e');
  rethrow;
}
```

### Resolution

Created centralized `ErrorHandler` (`lib/core/utils/error_handler.dart`) that bridges:
1. `debugPrint` (local dev)
2. `FirebaseCrashlytics.recordError` (production crash reporting)
3. GA4 `app_error` event (analytics dashboards)

All 28 catch blocks updated. Three crash capture layers configured in `main.dart`:
- `FlutterError.onError` — widget build errors
- `PlatformDispatcher.instance.onError` — async uncaught errors
- `runZonedGuarded` — zone-level errors

See: `docs/firebase/crashlytics-integration.md`

---

## 2. Shallow Analytics (RESOLVED)

### Problem

GA4 integration covered only basic funnel events (sign_up, cat_adopted, focus_session_*). Missing:
- Error tracking events
- Engagement depth metrics (feature usage, AI chat, diary generation)
- Session quality signals (completion ratio)
- Retention signals (app_opened with days_since_last)
- Economy system tracking (coins earned/spent, accessories)
- User lifecycle events (onboarding, first session)

### Resolution

Added 12 new GA4 events with corresponding logging methods in `AnalyticsService`. Added `app_opened` retention tracking with consecutive day counting. Full event catalog in `docs/firebase/analytics-events.md`.

---

## 3. Missing Performance Monitoring (RESOLVED)

### Problem

No Firebase Performance traces for key operations. Unable to measure:
- Focus session write latency
- LLM model load/generation time
- Diary generation duration
- Check-in transaction speed

### Resolution

Added `firebase_performance` dependency and created `AppTraces` utility (`lib/core/utils/performance_traces.dart`). 5 custom traces now measure critical operations. Each trace sets `status: success/error` attribute.

---

## 4. AI Coding Artifacts (RESOLVED)

### Problem

~76 files contained redundant Chinese pseudocode file headers (10-28 lines each), generated by an AI coding rule (`.claude/rules/22-code-header-template.md`). Headers added no value over existing `///` doc comments and inflated file sizes.

3 Claude rules files were irrelevant to the Flutter project:
- `03-glue-code-principles.md` — Python/general philosophy
- `04-project-structure.md` — Python project structure
- `22-code-header-template.md` — source of redundant headers

### Resolution

- Deleted all 3 irrelevant Claude rules
- Simplified `21-variable-naming-index.md` to Dart/Flutter naming conventions only
- Removed `// ---` pseudocode blocks from all 76 files

---

## 5. Hardcoded Strings (RESOLVED)

### Problem

6 English strings not covered by i18n:
- `'min'` / `'h'` time unit suffixes in adoption flow
- Weekday abbreviations `['M', 'T', 'W', ...]` in check-in calendar
- Attribution string in settings
- `'Your cat'` fallback in focus setup

### Resolution

Added 10 new l10n keys across all 5 ARB files (en, zh, zh_Hant, ja, ko). Updated 4 Dart files to use localized strings.

---

## 6. Large Screen Files (PENDING)

### Problem

8 screen files exceed 400 lines, mixing layout, logic, and component definitions in single files:

| File | Lines | Suggested Extractions |
|------|-------|-----------------------|
| `adoption_flow_screen.dart` | 831 | `habit_step.dart`, `cat_step.dart`, `name_step.dart` |
| `timer_screen.dart` | 695 | `timer_controls.dart`, `timer_progress_ring.dart` |
| `home_screen.dart` | 558 | `today_tab.dart`, `habit_list_section.dart` |
| `focus_complete_screen.dart` | 545 | `xp_breakdown_card.dart`, `stage_up_celebration.dart` |
| `check_in_screen.dart` | 545 | `calendar_grid.dart`, `check_in_milestones.dart` |
| `login_screen.dart` | 541 | `login_form.dart`, `social_login_buttons.dart` |
| `model_test_chat_screen.dart` | 525 | `chat_message_bubble.dart`, `model_test_input.dart` |
| `cat_chat_screen.dart` | 378 | `chat_bubble.dart`, `chat_input_bar.dart` |

### Recommendation

Extract private widgets into `components/` subdirectories within each screen's folder. Keep the main screen file as a composition of extracted components. Target: < 300 lines per file.

---

## 7. Offline Data Protection (RESOLVED)

### Problem

Firestore offline persistence is enabled, but edge cases (app crashes during writes) could lose focus session data — the most critical user action.

### Resolution

Created `OfflineWriteGuard` (`lib/core/utils/offline_write_guard.dart`) that:
1. Attempts the Firestore write normally
2. On failure, queues operation to SharedPreferences
3. Retries pending writes on next app launch

---

## Priority Matrix

| Issue | Severity | User Impact | Resolution Status |
|-------|----------|-------------|-------------------|
| Error handling | High | Invisible production bugs | RESOLVED |
| Shallow analytics | Medium | Missing engagement data | RESOLVED |
| No performance monitoring | Medium | Blind to latency issues | RESOLVED |
| AI coding artifacts | Low | Code noise, review friction | RESOLVED |
| Hardcoded strings | Low | Broken i18n for some locales | RESOLVED |
| Large screen files | Low | Maintainability | PENDING |
| Offline data protection | Medium | Potential data loss | RESOLVED |

---

## Changelog

- **2025-02**: Initial analysis and resolution of issues 1-5, 7
